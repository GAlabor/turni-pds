<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <title>Redirect Dropbox</title>
  </head>
  <body>
    <p id="status">Attendere… completamento accesso Dropbox</p>

    <script>
async function exchangeCodeForToken() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const status = document.getElementById("status");

  if (!code) { status && (status.textContent="Errore: nessun codice ricevuto."); return; }

  const verifier = localStorage.getItem("dbx_code_verifier");
  const body = new URLSearchParams({
    code,
    grant_type: "authorization_code",
    client_id: "2aw9gg2ov9tmzuc",
    redirect_uri: "https://astounding-entremet-ff96d4.netlify.app/redirect",
    code_verifier: verifier
  });

  try {
    const res = await fetch("https://api.dropboxapi.com/oauth2/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body
    });
    const data = await res.json();
    if (data.access_token) {
      localStorage.setItem("dropbox_token", data.access_token);

      // Se c'è un opener (flusso popup), notifico e chiudo
      if (window.opener) {
        try{
          const parentOrigin = new URL(document.referrer || "https://astounding-entremet-ff96d4.netlify.app").origin;
          window.opener.postMessage("DBX_OK", parentOrigin);
        }catch{
          window.opener.postMessage("DBX_OK", "https://astounding-entremet-ff96d4.netlify.app");
        }
        setTimeout(()=> window.close(), 250);
        return;
      }

      // Altrimenti (full redirect, tipico iOS standalone): torna alla home dell'app
      status && (status.textContent = "✅ Autorizzazione completata. Ritorno all’app…");
      setTimeout(()=>{
        // Torna alla root del sito dove sta l'app principale
        window.location.replace("https://astounding-entremet-ff96d4.netlify.app/");
      }, 300);
    } else {
      status && (status.textContent = "Errore nel recupero token.");
    }
  } catch (err) {
    status && (status.textContent = "Errore di rete durante il completamento.");
  }
}
exchangeCodeForToken();
</script>



  </body>
</html>
