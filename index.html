<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Canonicalizza l’URL su /turni-pds/ ed evita il BFCache zombie -->
  <script>
  (function(){
    var p = location.pathname;
    if (p === '/turni-pds' || p === '/turni-pds/index.html') {
      location.replace('/turni-pds/');
    }
  })();
  </script>

  <!-- Spingi i browser a non cacheare l'HTML -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>Turni Polizia di Stato</title>

  <!-- Manifest con query di versione -->
  <link rel="manifest" href="/turni-pds/manifest.webmanifest?v=2025-10-22-03">


  <!-- Colore tema -->
  <meta name="theme-color" content="#1976d2">

  <style>

  /* =========================================================
     [CSS-ROOT] Variabili tema e dimensioni standard
     ========================================================= */
  :root{
    --iosBlue:#1976d2; --iosBlue-600:#1565c0;
    --bg:#f3f5f8; --card:#ffffff; --gridBorder:#d9dee6;
    --text:#0b1320; --muted:#7a8595;
    --sunday:#c62828; --today:#cfe3ff;
    --T-GL:#c68bcf; --T-AP:#a47ac9;      /* colori fissi GL/AP */
    --fieldH:44px;                        /* altezza campi impostazioni */
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b0c10; --card:#14161a; --gridBorder:#222831; --text:#e6e8ec; --muted:#98a3af; --today:#103a7a }
  }

  /* =========================================================
     [CSS-BASE] Reset e tipografia
     ========================================================= */
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,"Helvetica Neue",Arial}

  /* =========================================================
     [CSS-TOPBAR] Barra blu + data di oggi
     ========================================================= */
.topbar {
  position: sticky;
  top: 0;
  z-index: 5;
  display: flex;
  align-items: center;
  gap: 10px;
  justify-content: center; /* Centra la scritta POLIZIA */
  padding: 10px 12px;
  background: var(--iosBlue);
  color: #fff;
}

.topbar .brand {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.08);
  box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.25);
}

/* La scritta POLIZIA */
.brand-title {
  font-weight: 800;
  letter-spacing: 0.2em;
}

.todayDate {
  font-size: 0.9rem;
  text-align: center;
  color: var(--muted);
  margin-top: 6px;
}

/* ===== [TOPBAR SVG WORDMARK] (SCALA, NON CAMBIA LAYOUT) ===== */
.brandmark{
  display:flex;
  align-items:center;
  justify-content:center;
  line-height:0;
}
.brandmark svg{
  display:block;
  height:24px;                 /* lascia 24px: è la “base” del layout */
  width:auto;
  transform: scale(var(--wmScale, 4.35));  /* ↑ ingrandisci qui */
  transform-origin: center;
}

/* per sicurezza, non tagliare eventuale ingrandimento */
.topbar{ color:#fff; overflow:visible; }




  /* =========================================================
     [CSS-LAYOUT] Main, barra mese, intestazioni giorni
     ========================================================= */
  main{max-width:760px;margin:8px auto 90px;padding:0 10px}
  .monthbar{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px;margin:10px 0 6px}
  .monthbar .title{text-align:center}
  .navbtn{appearance:none;border:0;background:transparent;color:var(--iosBlue);font-size:22px;line-height:1;cursor:pointer;padding:6px 8px;border-radius:10px}
  .navbtn:active{background:rgba(25,118,210,.12)}

  .weekhead{display:grid;grid-template-columns:repeat(7,1fr)}
  .weekhead div{background:var(--iosBlue);color:#fff;text-align:center;padding:8px 0;border:1px solid var(--iosBlue-600);font-weight:700}
  .weekhead div+div{border-left-width:0}

  .view{display:none}
  .view.active{display:block}

  /* =========================================================
   [CSS-CALENDAR GRID] Celle calendario  (VERSIONE AGGIORNATA)
   ========================================================= */
.grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  grid-auto-rows:minmax(62px,1fr);
}
.cell{
  position:relative;
  min-height:84px;
  background:var(--card);
  border:1px solid var(--gridBorder);
  border-top:0;
  display:flex;
  align-items:center;
  justify-content:center;
}
@media(max-width:560px){ .cell{ min-height:62px } }

/* Giorno del mese: SPOStATO A SINISTRA */
.num{
  position:absolute;
  left:8px;               /* <- prima era right:8px */
  top:6px;
  font-size:12px;
  color:var(--muted);
  font-weight:800;
}
.sun .num{ color:var(--sunday) }

/* Oggi evidenziato come prima */
.today{ background:var(--today) }

/* Sigla del turno: PIÙ IN BASSO */
.sigla{
  font-size:22px;
  font-weight:400;
  letter-spacing:.5px;
  opacity:.95;
  position:relative;
  top:8px;                /* <- spinta verso il basso */
}
.T-GL{ color:var(--T-GL) }
.T-AP{ color:var(--T-AP) }


  /* =========================================================
     [CSS-SETTINGS CARD] Struttura card impostazioni
     ========================================================= */
  .settingsCard{background:var(--card);border:1px solid var(--gridBorder);border-radius:10px;padding:14px;margin-top:10px}
  .settingsRow{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center;margin:8px 0}
  .settingsRow label{font-weight:600;color:var(--muted)}
  .settingsRow input,.settingsRow select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--gridBorder);background:var(--card);color:var(--text);height:var(--fieldH)}
  .savebtn{margin-top:12px;padding:10px 14px;border:0;border-radius:10px;background:var(--iosBlue);color:#fff;font-weight:700;cursor:pointer}

/* =========================================================
   [CSS-TABBAR] Navigazione in basso — stile uniforme
   ========================================================= */
.tabbar{
  position:fixed;
  bottom:0; left:0; right:0;
  background:var(--card);
  border-top:1px solid var(--gridBorder);
  display:flex;
  justify-content:space-around;
  gap:10px;
  padding:8px 10px;
  z-index:10;
}

/* Variabili comode per dimensioni */
:root{
  --tabW: 56px;           /* desktop larghezza */
  --tabH: 46px;           /* desktop altezza   */
  --tabIcon: 22px;        /* desktop icona     */
  --tabColor: #b7bcc6;    /* grigio icona/testo default (dark) */
  --tabColorActive: #e3e7ec;
  --tabHoverBg: rgba(255,255,255,.10);
  --tabActiveBg: rgba(255,255,255,.14);
}
@media (prefers-color-scheme: light){
  :root{
    --tabColor: #6d7786;        /* grigio su chiaro */
    --tabColorActive: #1f2937;
    --tabHoverBg: rgba(0,0,0,.06);
    --tabActiveBg: rgba(0,0,0,.10);
  }
}

/* Ogni icona/tab */
.tab{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  width:var(--tabW);
  height:var(--tabH);
  border-radius:12px;
  background:transparent;
  color:var(--tabColor);
  font-size:12px;
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;
  transition: background-color .18s ease, color .18s ease, transform .06s ease;
}

/* Icone SVG: stesso tratto, niente sovrapposizioni visive */
.tab svg{
  width:var(--tabIcon);
  height:var(--tabIcon);
  display:block;
  fill:none;
  stroke:currentColor;
  stroke-width:2.25;
  stroke-linecap:round;
  stroke-linejoin:round;
}

/* Stato attivo: colore + leggero fill dell’intero tasto */
.tab.active{
  color:var(--tabColorActive);
  background:var(--tabActiveBg);
  font-weight:700;
}

/* Hover → illumina tutto il bottone, non solo il bordo */
.tab:hover{
  background:var(--tabHoverBg);
  color:var(--tabColorActive);
  transform:translateY(-1px);
}

/* Click */
.tab:active{
  background:var(--tabActiveBg);
  transform:translateY(1px);
}

/* Testo compatto sotto l’icona (se lo usi) */
.tab span{ line-height:1; }

/* Mobile: più piccoli, stop alle padelle giganti */
@media (max-width:560px){
  :root{
    --tabW: 48px;
    --tabH: 40px;
    --tabIcon: 18px;
  }
}


  /* =========================================================
     [CSS-FORMS TWEAKS] Campi, bottoni e griglia turni
     ========================================================= */
  .siglaInput{max-width:70px;text-transform:uppercase}
  .turni-grid .siglaInput{max-width:70px}
  .orarioInput{width:100%}
  .thin-sep{height:0;border-top:1px solid var(--gridBorder);margin:6px 0}
  .iconbtn{width:var(--fieldH);height:var(--fieldH);border-radius:8px;padding:0;font-size:20px;display:flex;align-items:center;justify-content:center;border:0}
  .iconbtn-primary{background:var(--iosBlue);color:#fff}
  .iconbtn-danger{background:#b42325;color:#fff}
  .iconbtn:active{transform:translateY(1px)}
  @media(max-width:560px){
    .turni-grid{grid-template-columns:1fr 80px 2fr 90px 44px !important}
    .settingsRow{grid-template-columns:120px 1fr}
  }
.hide-topbar .topbar,           /* barra blu POLIZIA */
.hide-topbar #todayHeaderRow{   /* riga data + icona Dropbox */
  display: none !important;
}

/* Compensa lo spazio sopra quando le barre sono nascoste */
.hide-topbar main{
  margin-top: 8px; /* metti 0 se vuoi tutto attaccato */
}

/* =========================================================
   [CSS-COLOR PICKER] Quadretto colore = altezza campi
   ========================================================= */
.colorCell{
  display:flex;
  align-items:center;
  justify-content:center;
}

/* Il controllo ha ESATTAMENTE la stessa altezza dei campi */
.colorInput{
  -webkit-appearance:none; appearance:none;
  box-sizing:border-box;
  width:var(--fieldH);
  height:var(--fieldH);
  aspect-ratio:1/1;             /* forza il quadrato dove supportato */
  padding:0;
  margin:0;
  border:1px solid var(--gridBorder);
  border-radius:8px;            /* stessa raggiatura dei campi */
  background:transparent;
  min-width:0;
  line-height:normal;
}
/* Chrome/Safari: niente padding/bordi interni */
.colorInput::-webkit-color-swatch-wrapper{ padding:0; }
.colorInput::-webkit-color-swatch{ border:none; border-radius:6px; }
/* Firefox: allinea il “swatch” */
.colorInput::-moz-color-swatch{ border:none; border-radius:6px; }

/* Mobile: campi un filo più compatti → il quadretto segue */
@media (max-width:560px){
  :root{ --fieldH:40px; }
}
/* =========================================================
   [CSS-GRID TURNI OVERRIDE v4] Sigla 4 char + Orario più corto
   ========================================================= */
/* Desktop / tablet */
.turni-grid{
  /* 1) Turno   2) Sigla   3) Orario   4) Colore   5) Azione */
  grid-template-columns: 1fr 64px 1.05fr 52px 44px !important;
  align-items:center;
}

/* Sigla comoda per 4 lettere */
.siglaInput{
  width:100%;
  max-width:none;
  text-transform:uppercase;
  text-align:center;
  letter-spacing:0.5px;
}

/* Orario: solo dimensioni base qui. La stilizzazione completa è sotto */
.orarioArea{
  min-width:0;
  width:100%;
}

/* Mobile stretto */
@media (max-width:560px){
  .turni-grid{
    grid-template-columns: 1fr 60px 0.85fr 46px 44px !important;
  }
  .siglaInput{ width:100%; }
}

/* =========================================================
   [CSS-APP DATE FIELD v3] Altezza ridotta + testo centrato
   ========================================================= */
.settingsRow input[type="date"]{
  width:95%;
  min-width:0;
  font-size:1rem;
  height:38px;                 /* più basso del precedente (~44px) */
  line-height:38px;            /* centra la data in verticale */
  text-align:center;           /* centra orizzontalmente il testo */
  margin:0 auto;
  display:block;
  box-sizing:border-box;
  border-radius:8px;
}

@media (max-width:560px){
  .settingsRow input[type="date"]{
    width:92%;
    font-size:1.05rem;
    height:36px;               /* ancora un po’ più compatto in app */
    line-height:36px;
  }
}


/* =========================================================
   [CSS-ORARIO MULTILINEA] Un solo campo, 2 righe (inizio/fine)
   ========================================================= */
.orarioArea{
  display:block;
  width:100%;
  min-width:0;
  height:calc(var(--fieldH) + 2px);   /* più basso di prima */
  padding:6px 8px;
  resize:none;
  line-height:1.05;
  font-size:0.86rem;                  /* più piccolo */
  border:1px solid var(--gridBorder);
  border-radius:8px;
  background:var(--card);
  color:var(--text);
  box-sizing:border-box;
  white-space:pre;                    /* rispetta il \n */
}
@media (max-width:560px){
  .orarioArea{ font-size:0.8rem; height:calc(var(--fieldH)); }
}


/* micro-spazi */
.settingsRow{ gap:8px; }
@media (max-width:560px){
  .settingsRow{ gap:6px; }
  .turni-grid > div:first-child input{ padding-left:8px; } /* Turno parte un filo più a sx */
}

/* =========================================================
   [CSS-DROPBOX UI] Icona stato + popup modale
   ========================================================= */
.dropboxIconBtn{
  display:inline-flex; align-items:center; justify-content:center;
  width:36px; height:36px;                 /* ↑ più grande */
  margin-left:8px; cursor:pointer;
  border-radius:6px;
  border:1px solid transparent;
  background:transparent;
}
.dropboxIconBtn:hover,
.dropboxIconBtn:focus,
.dropboxIconBtn:active{
  background:transparent;
  border-color:transparent;
  box-shadow:none;
}
.dropboxIconBtn svg{
  display:block;
  width:28px; height:28px;                 /* ↑ più grande */
  background:transparent;
}
.dropboxIconBtn:active{ transform:translateY(1px); }
.dropboxIconBtn svg{ display:block; width:22px; height:22px; }

/* Stato NON connesso: stesso colore della data */
.dbx-off{ color: var(--muted); }
.dbx-off svg path{ fill: currentColor; }

/* Stato connesso: blu tema */
.dbx-on{ color: var(--iosBlue); }
.dbx-on svg path{ fill: currentColor; }

/*.dbx-on svg path{ fill:#1976d2; } vecchio colore per stato connesso */

/* Modale leggero */
.modalBackdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.35);
  display:none; align-items:center; justify-content:center; z-index:50;
}
.modalBackdrop.active{ display:flex; }
.modalCard{
  width:min(480px, 92vw); background:var(--card);
  border:1px solid var(--gridBorder); border-radius:12px;
  padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.25);
}
.modalHeader{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
.modalTitle{ font-weight:700; }
.modalBody{ margin-top:10px; color:var(--muted); }
.modalActions{ margin-top:14px; display:flex; gap:8px; justify-content:flex-end; }

/* =========================================================
   [CSS-TEXT BUTTONS] Bottoni testuali per azioni leggere
   ========================================================= */
.textbtn{
  appearance:none; border:1px solid var(--gridBorder);
  background:transparent; color:var(--text);
  padding:8px 12px; border-radius:8px; cursor:pointer;
  font-weight:600; font-size:.92rem;
}
.textbtn:active{ transform:translateY(1px); }
.textbtn-danger{
  border-color:#b42325; color:#b42325;
}
.textbtn-danger:active{ border-color:#96201f; }


/* =========================================================
   [CSS-SETTINGS ACTIONS] Pulsanti Salva/Importa — stile uniforme
   ========================================================= */

/* knob rapidi (desktop) */
:root{
  --actBtn:    44px;          /* lato bottone */
  --actIcon:   24px;          /* lato icona   */
  --actStroke: 2.25px;        /* spessore tratto */

  /* Colori SOLIDI per evitare scurimenti nelle sovrapposizioni */
  --actColor:    #bcc3cc;     /* icona “spenta” (dark) */
  --actColorHi:  #e6e9ee;     /* icona “accesa” (dark) */

  /* Hover/Active: solo il fondo resta semitrasparente */
  --actHover:  rgba(255,255,255,.12);
  --actActive: rgba(255,255,255,.18);
}
@media (prefers-color-scheme: light){
  :root{
    --actColor:    #586069;   /* grigio pieno (light) */
    --actColorHi:  #1f2328;   /* quasi-nero pieno (light) */
    --actHover:    rgba(0,0,0,.08);
    --actActive:   rgba(0,0,0,.12);
  }
}

.actionIcons{
  display:flex; flex-wrap:wrap; gap:10px; align-items:center;
}

/* Bottone icon-only */
.btn-icon{
  display:inline-flex; align-items:center; justify-content:center;
  width:var(--actBtn); height:var(--actBtn);
  padding:0; border:none; border-radius:12px;
  background:transparent;                 /* niente fondo/ombra a riposo */
  color:var(--actColor);
  cursor:pointer;
  transition: background .18s ease, color .18s ease, transform .06s ease;
}
.btn-icon:hover{
  background:var(--actHover);
  color:var(--actColorHi);
  transform:translateY(-1px);
}
.btn-icon:active{
  background:var(--actActive);
  color:var(--actColorHi);
  transform:translateY(1px);
}

/* SVG interni: tratto uniforme, angoli arrotondati, NO doppie linee */
.btn-icon svg{
  width:var(--actIcon); height:var(--actIcon);
  display:block; flex-shrink:0;
  stroke:currentColor; fill:none;
}
/* forza opacità piena del tratto: niente aloni in sovrapposizione */
.btn-icon svg,
.btn-icon svg *{
  stroke-linecap:round; stroke-linejoin:round;
  stroke-width:var(--actStroke);
  vector-effect:non-scaling-stroke;
  stroke-opacity:1;
}

/* niente label visibile */
.btn-icon span{ display:none; }

/* Mobile un filo più compatto */
@media (max-width:560px){
  :root{
    --actBtn:   40px;
    --actIcon:  22px;
    --actStroke: 2px;
  }
}


  </style>
</head>

<body>
  <!-- =======================================================
       [HTML-TOPBAR] Logo + scritta POLIZIA STRADALE + data
       ======================================================= -->
  <div class="topbar" aria-label="Intestazione Polizia Stradale">
  <div class="brandmark" aria-label="Polizia" role="img">
    <svg viewBox="0 0 1536 1024" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <!-- BACKGROUND RIMOSSO -->
      <path d="M419 416h124l11 3 8 7 4 11 1 10-2 15-9 39-11 52-4 15-6 12-8 8-9 5-10 3-8 1H391l-15-2-10-3-6-4-4-5-4-10v-17l7-35 10-43 7-30 5-12 9-10 7-5 14-4zM1266 415l91 1 6 3 4 6 2 15 4 49 9 93 1 13-1 2h-68l-1-2-2-29-2-6-5-2-55 1-4 5-10 25-3 8h-63l-2-2v-7l6-16 16-36 11-26 9-20 19-45 8-16 4-6 10-6zM253 415h29l21 1 14 2 8 3 6 5 5 9 3 11v8l-6 31-5 17-8 17-8 10-9 7-11 4-15 2-30 1-53 1-3 3-4 13-6 30-3 6-1 1h-59l-1-1 1-11 24-123 6-28 3-10 4-5 6-3zM1070 415l9 2 2 6-3 17-5 12-11 12-17 14-14 11-13 11-14 11-13 11-14 11-13 10-3 5 1 6 12 3 69 1 6 2 1 2v7l-5 21-3 6-1 1H857l-4-2-1-7 4-13 6-12 12-12 11-9 13-12 11-9 8-8 14-11 16-13 13-10 16-13h2v-8l-3-3-91-1-2-2 1-11 5-23 2-2zM606 416h59l2 2-1 9-8 39-10 51-5 26v11l5 3 77 1 7 2 1 1v9l-6 26-1 1H596l-11-4-6-5-5-10v-15l20-99 8-38 3-9zM797 416h60l1 2-6 32-9 45-15 81-4 17-3 4-52 1-6-5-1-3v-12l21-107 6-33 5-19zM1116 415l55 1 1 1-1 12-13 66-10 53-8 38-3 10-1 1h-60l-1-4 22-111 10-51 4-13z" fill="#fff"/>
      <path d="M889 409h190l5 2 3 4v12l-5 19-5 10-9 10-13 11-11 9-13 11-14 11-32 26-11 9-2 3v3l2 1 73 2 6 3 3 4 1 7-6 29-3 7-3 2H853l-6-3-1-1v-12l6-18 6-11 11-11 11-9 12-11 11-9 11-11 14-11 18-14 13-11 8-7v-3l-84-1-6-3-2-4v-8l6-28 4-7zm181 6-180 1-3 5-5 25v6l2 2 91 1 3 3v8l-4 2-16 13-13 10-25 20-20 18-8 7-14 12-12 11-5 6-6 12-3 11 1 7 4 2h184l3-4 5-19 1-5v-7l-2-3-5-1-69-1-12-3-1-6 4-6 13-10 16-13 11-9 16-13 10-8 11-9 16-13 10-9 6-8 5-13 2-16-2-4zM444 454h48l4 4v9l-8 43-8 37-3 7-4 3-40 1-9-2-3-4v-13l12-57 6-23z" fill="#0173DB"/>
      <path d="M890 403h190l8 4 4 6v15l-4 18-4 9-8 11-12 11-10 8-13 11-9 7-11 9-17 14-14 11-6 5v3l2 1 64 1 7 4 4 5 1 2v13l-7 29-4 6-6 4H851l-6-3-3-5-1-2v-11l4-17 6-12 10-12 11-9 15-14 8-7 14-12 10-9 14-11 16-13 7-6v-1l-78-1-5-3-3-5v-12l6-29 4-8 6-4zm-1 6-5 3-3 6-6 28v8l3 5 5 2 84 1-1 4-11 10-10 8-17 13-11 9-10 9-13 12-8 7-14 12-10 9-6 7-6 13-4 13v12l4 3 3 1h192l4-4 3-10 5-25-2-7-5-5-3-1-73-2-2-1 1-5 9-8 14-11 13-11 17-13 15-13 11-9 17-14 9-10 5-12 4-16v-12l-4-5-4-1z" fill="#fff"/>
      <path d="M1260 408h86l15 2 8 5 4 7 2 8 3 37 9 99 2 19v14l-4 4-2 1h-71l-4-2-2-8-1-26-1-3-2-1h-47l-4 1-2 5-8 21-4 10-5 3h-63l-7-3-2-9 3-12 17-39 18-42 11-25 12-28 8-17 8-11 8-6 9-3zm6 7-16 2-10 6-6 9-13 29-10 24-11 25-12 28-18 41-3 9v7l2 2h63l10-26 5-10 2-2 55-1 5 2 2 6 2 29 1 2h68l1-6-6-60-7-77-2-25-3-8-5-4-3-1zM171 408l127 1 19 2 10 3 10 7 6 10 3 12-2 22-7 30-6 16-6 11-9 11-7 6-11 5-14 3-9 1-78 1-3 9-7 35-4 7-8 4h-58l-5-3-1-2v-10l14-75 15-75 4-14 6-9 5-4 8-3zm82 7-92 1-8 5-4 9-6 27-22 112-4 22v5l1 1h59l3-4 6-28 4-15 3-5 1-1 53-1 30-1 19-3 10-5 9-8 7-11 7-16 5-19 5-26v-8l-3-11-5-9-8-6-11-3-9-1-21-1zM423 409h119l10 2 9 4 7 6 4 8 1 3 1 18-5 23-14 63-6 29-8 16-7 8-9 8-11 4-14 2-64 1h-35l-24-2-15-4-8-6-6-9-2-7v-17l7-38 11-50 7-27 7-14 9-10 9-6 16-4zm-4 7-16 3-9 4-8 7-6 8-5 14-6 26-13 57-4 21v17l4 10 6 7 9 4 10 2 10 1h109l16-3 8-4 10-9 5-8 5-16 9-42 11-49 2-9 1-11-2-13-4-8-7-6-11-3zM605 409h64l5 5v8l-7 33-18 90 1 5 70 1 12 1 6 4 2 5-1 11-5 24-3 5-3 2-7 1H598l-12-3-8-4-6-7-3-8-1-6v-8l8-46 19-95 4-12 4-5zm1 7-3 6-8 36-21 105v15l5 10 8 6 9 3h130l3-8 4-19v-9l-2-2-6-1-77-1-5-3v-11l10-51 7-36 6-29 1-9-2-2z" fill="#0173DB"/>
      <path d="M1256 403h100l9 2 6 4 5 6 3 9 2 17 6 70 8 80-1 10-4 6-7 3h-69l-7-3-4-5-1-3-2-29-4-1h-36l-5 2-4 8-9 24-5 5-5 2h-60l-9-2-5-4-2-4v-14l4-12 18-41 11-26 19-44 11-26 8-15 10-11 10-6zm4 5-13 3-9 6-7 9-8 16-10 22-11 26-15 34-11 26-13 30-3 12 2 9 7 3h63l5-3 6-16 7-17 1-3 4-1h47l2 1 1 3 1 26 2 8 4 2h71l5-3 1-2v-14l-7-72-6-69-1-14-3-11-5-6-10-4-11-1zM164 403h132l20 2 12 3 9 5 7 7 5 11 2 10v15l-8 37-7 19-6 12-9 12-11 9-12 5-16 3-11 1-70 1-4 15-5 26-5 8-7 5-5 1h-58l-7-4-3-4-1-3 1-17 7-39 13-67 7-35 5-18 7-10 7-6zm7 5-12 2-8 5-6 8-3 8-6 27-11 56-14 75v10l4 4 2 1h58l8-4 4-7 7-35 3-9 78-1 20-3 12-5 8-6 8-9 8-14 6-16 7-30 2-22-3-12-6-10-10-7-10-3-19-2zM426 403h115l15 3 10 5 6 5 5 10 2 6v22l-11 47-11 54-4 15-8 15-8 10-10 7-9 4-16 3-70 1h-35l-21-2-15-4-10-6-6-8-4-11-1-5 1-18 7-37 13-57 5-20 8-16 10-11 10-6 13-4zm-3 6-16 2-13 4-9 7-8 9-6 13-10 40-10 47-5 28v17l4 11 7 8 8 4 12 3 24 2h35l64-1 17-3 9-4 8-7 7-8 8-16 16-75 8-34 1-12-1-12-4-9-6-7-8-4-6-2-7-1zM605 403h63l7 3 3 3 1 2v13l-10 46-9 46-4 21v8l74 1 8 3 5 4 2 5v12l-6 28-3 6-6 5-3 1H597l-15-4-9-6-6-7-4-12v-13l8-43 12-61 5-28 4-19 4-8 6-5zm0 6-5 4-4 11-6 28-17 86-5 30v8l3 12 6 8 6 4 9 3 6 1h125l7-2 3-3 5-21 2-11-1-9-5-5-2-1-12-1-70-1-1-5 22-110 3-13v-8l-5-5zM1112 403h59l9 3 3 4 1 4v10l-6 31-23 115-6 28-5 8-4 3-4 1h-63l-7-3-3-6 1-10 9-45 8-45 7-37 10-47 4-8 6-5zm0 6-5 3-4 8-9 42-8 43-7 37-10 50-1 8 3 4h67l5-5 3-10 10-48 15-78 6-32 2-9v-7l-4-5-2-1z" fill="#fff"/>
      <path d="m259 453 8 1 3 3v9l-2 15-3 12-3 6-5 4h-50l-4-3v-11l6-29 4-5 2-1z" fill="#0173DB"/>
      <path d="M798 403h61l7 3 4 8v7l-20 100-12 63-4 17-5 6-7 3h-55l-8-4-7-8-1-2v-21l19-98 8-40 6-23 4-6 5-4zm-3 6-6 5-5 18-7 36-8 41-11 57-2 10v19l7 8 3 1h57l6-5 6-26 8-44 7-35 7-37 7-34v-9l-4-4-2-1z" fill="#fff"/>
      <path d="M452 465h31l2 2-1 10-15 64-2 4-2 1h-28l-3-2v-11l10-48 5-18zM1293 460l7 1 4 4 2 6 2 26v15l-5 5-3 1h-19l-9-2-4-5 3-10 12-31 4-7z" fill="#0173DB"/>
      <path d="M448 460h40l2 3v8l-14 64-4 13-3 3-26 1-12-1-3-3v-11l12-57 4-15zm4 5-4 4-8 34-6 30v11l3 2h28l3-2 8-33 9-38v-6l-2-2z" fill="#fff"/>
      <path d="M223 465h34l2 2-2 14-3 10-3 2h-32l-3-3 1-9 3-13z" fill="#0173DB"/>
      <path d="M220 460h42l2 2v9l-4 19-4 6-3 2h-40l-3-3 1-11 4-19zm3 5-3 3-4 18 1 6 2 1h32l4-4 4-19-1-4-1-1zM1294 467l4 1 2 8 1 12v21l-2 2h-21l-2-2 1-7 12-30z" fill="#fff"/>
      <path d="M1292 479h2l1 5 1 19-2 3-5 1-6-2 3-10z" fill="#0173DB"/>
    </svg>
  </div>
</div>



  <div class="todayDate" id="todayHeaderRow" style="display:flex;align-items:center;justify-content:center;gap:8px">
  <span id="todayHeader"></span>
  <!-- =========================================================
       [UI-DROPBOX ICON HEADER] Stato collegamento (clic = collega)
       ========================================================= -->
  <button id="dbxIconHeader" class="dropboxIconBtn dbx-off" title="Collega Dropbox" aria-label="Collega Dropbox">
    <!-- Logo Dropbox (SVG) -->
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M6.5 3L12 6.5 7 9.5 1.5 6zM17.5 3L23 6 17 9.5 12 6.5zM7 10.5l5 3.5-5 3.5L1.5 14zM17 10.5l5.5 3.5L17 17.5l-5-3.5zM12 18l5 3-5 3-5-3z" fill="currentColor"/>
    </svg>
  </button>
</div>

  <!-- =======================================================
       [HTML-CALENDAR VIEW] Vista calendario
       ======================================================= -->
  <main>

    <section class="view active" id="view-calendar">
      <div class="monthbar">
        <button class="navbtn" id="prev">&#x276E;</button>
        <div class="title" id="monthLabel">ottobre 2025</div>
        <button class="navbtn" id="next">&#x276F;</button>
      </div>
      <div class="weekhead"><div>LUN</div><div>MAR</div><div>MER</div><div>GIO</div><div>VEN</div><div>SAB</div><div>DOM</div></div>
      <section class="grid" role="grid" aria-labelledby="monthLabel"></section>
    </section>

    <!-- =====================================================
         [HTML-SETTINGS VIEW] Vista impostazioni
         ===================================================== -->
    <section class="view" id="view-settings">
      <div class="settingsCard" id="set-turni">
        <!-- [SET-REF SHIFT] Primo giorno -->
        <div class="settingsRow" style="grid-template-columns:120px 1fr">
          <label>Primo giorno</label>
          <input type="date" id="startDate" />
        </div>
        
      <!-- =========================================================
     [UI-ACTIONS] Salva su Dropbox + Importa da Dropbox (icone nuove)
     ========================================================= -->
<div class="settingsRow" style="grid-template-columns:1fr; align-items:center; margin-top:6px">
  <div class="actionIcons">
    <!-- Salva su Dropbox -->
    <button id="btnSaveCloud" class="btn-icon" aria-label="Salva su Dropbox" title="Salva su Dropbox">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M7.7647 4H5a1 1 0 0 0-1 1v11.5376c0 .293.129.571.352.761L8.4258 20.7619A1 1 0 0 0 9.0735 21H19a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-2.7647M7.7647 4v5a1 1 0 0 0 1 1h6.4706a1 1 0 0 0 1-1V4M7.7647 4h8.4706"/>
    <path d="M9 21v-5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v5"/>
  </svg>
</button>

    <!-- Importa da Dropbox -->
    <button id="btnImportCloud" class="btn-icon" aria-label="Importa da Dropbox" title="Importa da Dropbox">
  <svg viewBox="0 0 72 72" aria-hidden="true">
    <path d="M20 15h14l6 6h20v32a4 4 0 0 1-4 4H20a4 4 0 0 1-4-4V19a4 4 0 0 1 4-4z"/>
    <path d="M36 46V30"/>
    <path d="M30 36l6-6 6 6"/>
  </svg>
</button>
  </div>
</div>

<!-- =========================================================
     [UI-DROPBOX ICON SETTINGS] Icona + stato + Disconnetti
     ========================================================= -->
<div class="settingsRow" style="grid-template-columns:1fr;align-items:center">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <button id="dbxIconSettings" class="dropboxIconBtn dbx-off" title="Collega Dropbox" aria-label="Collega Dropbox">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M6.5 3L12 6.5 7 9.5 1.5 6zM17.5 3L23 6 17 9.5 12 6.5zM7 10.5l5 3.5-5 3.5L1.5 14zM17 10.5l5.5 3.5L17 17.5l-5-3.5zM12 18l5 3-5 3-5-3z" fill="currentColor"/>
      </svg>
    </button>

    <span id="dropboxStatus" class="todayDate"></span>

    <!-- Pulsante disconnessione: visibile solo quando connessi -->
    <button id="dbxDisconnect" type="button" class="textbtn textbtn-danger" style="display:none">
      Disconnetti
    </button>
  </div>
</div>


        <hr style="border:none;border-top:1px solid var(--gridBorder);margin:12px 0" />

        <!-- [SET-HEAD] Intestazioni turni -->
        <div class="settingsRow turni-grid turni-head" style="grid-template-columns:1fr 80px 2fr 90px 44px; align-items:center">
          <div style="font-weight:700;color:var(--muted)">Turno</div>
          <div style="font-weight:700;color:var(--muted)">Sigla</div>
          <div style="font-weight:700;color:var(--muted)">Orario</div>
          <div style="font-weight:700;color:var(--muted)">Colore</div>
          <div></div>
        </div>
        <div class="thin-sep"></div>

        <!-- [SET-ADD ROW] Riga “Aggiungi turno” -->
        <div class="settingsRow turni-grid" style="grid-template-columns:1fr 80px 2fr 90px 44px; align-items:center">
  <div><input id="newNome"></div>
  <div><input id="newSigla" class="siglaInput" maxlength="4"></div>
  <textarea id="newOrario" class="orarioArea" rows="2" placeholder="00:00&#10;00:00"></textarea>
  <div class="colorCell"><input id="newColor" class="colorInput" type="color" value="#8e88ff" title="Colore"></div>
  <button id="btnAddTurno" type="button" class="iconbtn iconbtn-primary" title="Aggiungi">+</button>
</div>


        <!-- [SET-LIST] Elenco turni -->
        <div id="turniList"></div>
      </div>
    </section>

    <!-- =========================================================
     [UI-DROPBOX MODAL] Popup collegamento
     ========================================================= -->
<div id="dbxModal" class="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="dbxModalTitle">
  <div class="modalCard">
    <div class="modalHeader">
      <div class="modalTitle" id="dbxModalTitle">Collega Dropbox</div>
      <button id="dbxModalClose" class="iconbtn iconbtn-danger" title="Chiudi">✕</button>
    </div>
    <div class="modalBody">
      Verrà aperta una finestra di Dropbox per l’autorizzazione. Dopo il collegamento, tornerai al calendario.
    </div>
    <div class="modalActions">
      <button id="dbxModalGo" class="savebtn">Procedi</button>
    </div>
  </div>
</div>


  </main>

  <!-- =======================================================
     [HTML-TABBAR] Navigazione inferiore
     ======================================================= -->
<nav class="tabbar" aria-label="Barra schede">
  <div class="tab active" data-tab="calendar" aria-label="Calendario">
    <!-- Icona Calendario (stroke = currentColor, fill = none) -->
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
         fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="16" y1="2" x2="16" y2="6"></line>
      <line x1="8" y1="2" x2="8" y2="6"></line>
      <line x1="3" y1="10" x2="21" y2="10"></line>
    </svg>
    <!--<span>Calendario</span>--> <!-- togli la parte dei commenti per avere il nome sotto l'icona -->
  </div>

  <div class="tab" data-tab="settings" aria-label="Impostazioni">
    <!-- Icona Impostazioni -->
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
         fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="12" cy="12" r="3"></circle>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33
               1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51
               1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06
               a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09
               a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06
               a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09
               a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09
               a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06
               a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09
               a1.65 1.65 0 0 0-1.51 1z"/>
    </svg>
    <!--<span>Impostazioni</span>--> <!-- togli la parte dei commenti per avere il nome sotto l'icona -->
  </div>
</nav>


  <!-- =======================================================
     [JS-MAIN] Script principale pagina Turni PDS
     ======================================================= -->

  <script>
  "use strict";

  // =========================================================
  // [FN: util_jsWeekdayUTC] Lunedì=0 … Domenica=6 (UTC)
  // =========================================================
  function util_jsWeekdayUTC(d){ return (d.getUTCDay()+6)%7 }

  // =========================================================
  // [FN: util_pad2] Padding numeri a 2 cifre
  // =========================================================
  function util_pad2(n){ return n.toString().padStart(2,'0') }

  // =========================================================
  // [FN: util_fmtMonth] “ottobre 2025”
  // =========================================================
  function util_fmtMonth(fmt,y,m){ return fmt.format(new Date(y,m,1)) }
  // =========================================================
  // [FN: util_splitOrario] "07:00–13:00" -> {start:"07:00", end:"13:00"}
  // [FN: util_joinOrarioMultiline] "riga1\nriga2" -> "riga1–riga2"
  // =========================================================
function util_splitOrario(s){
  const parts = String(s||'').split(/[-–—]/).map(x=>x.trim());
  return { start: parts[0]||'', end: parts[1]||'' };
}
function util_joinOrarioMultiline(txt){
  const [rawS='', rawE=''] = String(txt||'').split(/\n/);
  const s = (rawS || '').trim();
  const e = (rawE || '').trim();
  return (s || e) ? `${s}–${e}` : '';
}

// =======================================================
// [STORAGE PAYLOAD] Cosa salviamo su Dropbox
// =======================================================
function storage_buildPayload(){
  return {
    _meta:{
      app:"Turni Polizia di Stato",
      version:1,
      savedAt:new Date().toISOString()
    },
    settings: settings_effective(),     // {date, shift}
    defs:     defs_effective()          // lista turni personalizzati
  };
}

// Nome file: YYYY-MM-TURNI.json (es. 2025-10-TURNI.json)
function storage_buildFilename(){
  const now = new Date();
  const y = now.getFullYear();
  const m = util_pad2(now.getMonth()+1);
  return `${y}-${m}-TURNI.json`;
}



  // =========================================================
  // [BLOCK: JS-STATE] Formatter, date e riferimenti DOM
  // =========================================================
  const itMonth = new Intl.DateTimeFormat('it-IT',{month:'long',year:'numeric'});
  const today   = new Date();
  let   view    = new Date(Date.UTC(2025,9,1)); // demo: ottobre 2025

  const grid        = document.querySelector('.grid');
  const monthLabel  = document.getElementById('monthLabel');
  const todayHeader = document.getElementById('todayHeader');

  // =========================================================
  // [BLOCK: STORAGE KEYS] LocalStorage + default turni
  // =========================================================
  const LS_KEY   = 'cal_turno_start_v1';
  const LS_TURNS = 'cal_turni_defs_v2';

  const SHIFT_DEFAULTS = [
    { key:'S', nome:'Sera',       sigla:'S', orario:'18:55–00:08', color:'#8e88ff' },
    { key:'P', nome:'Pomeriggio', sigla:'P', orario:'12:55–19:08', color:'#c7a47b' },
    { key:'M', nome:'Mattina',    sigla:'M', orario:'06:55–13:08', color:'#f1a04f' },
    { key:'N', nome:'Notte',      sigla:'N', orario:'23:55–07:08', color:'#9aa3ad' },
    { key:'R', nome:'Riposo',     sigla:'R', orario:'—',           color:'#28a745' }
  ];

  // =========================================================
  // [FN: defs_load / defs_save / defs_effective]
  // Gestione definizioni turni personalizzate
  // =========================================================
  function defs_load(){ try{ return JSON.parse(localStorage.getItem(LS_TURNS))||null }catch{ return null } }
  function defs_save(list){ localStorage.setItem(LS_TURNS, JSON.stringify(list)) }
  function defs_effective(){
    const l = defs_load();
    let out = Array.isArray(l) && l.length ? l : SHIFT_DEFAULTS.slice();
    out = out.map(item => ({
      key:   (item.key||(['S','P','M','N','R'].includes(item.sigla)?item.sigla:'S')),
      nome:  item.nome||'',
      sigla: item.sigla||'',
      orario:item.orario||'',
      color: item.color||'#8e88ff'
    }));
    defs_save(out);
    return out;
  }

  // =========================================================
  // [FN: settings_*] Primo giorno (data+base)
  // =========================================================
  function settings_load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||null }catch{ return null } }
  function settings_save(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)) }
  function settings_effective(){
    const s=settings_load();
    if(s && s.date && s.shift) return s;
    const t=new Date();
    const def={date:`${t.getFullYear()}-${util_pad2(t.getMonth()+1)}-${util_pad2(t.getDate())}`, shift:'S'};
    settings_save(def); return def;
  }

  // =========================================================
  // [FN: shifts_codeForDate] Calcolo ciclo S→P→M→N→R + GL/AP
  // =========================================================
  const BASE_SEQ=['S','P','M','N','R'];
  function shifts_codeForDate(d){
    const cfg=settings_effective();
    const [y,m,dd]=cfg.date.split('-').map(Number);
    const anchor=new Date(Date.UTC(y,m-1,dd));
    const idx0=BASE_SEQ.indexOf(cfg.shift);
    const daysDiff=Math.floor((Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate())-Date.UTC(anchor.getUTCFullYear(),anchor.getUTCMonth(),anchor.getUTCDate()))/86400000);
    const step=((idx0+(daysDiff%5)+5)%5);
    const raw=BASE_SEQ[step];
    if(raw!=='R') return raw;
    const dow=util_jsWeekdayUTC(d);
    if(dow===0) return 'GL';
    if(dow===1) return 'AP';
    return 'R';
  }

  // =========================================================
  // [FN: ui_displayLabelFor / ui_colorForBase]
  // Etichetta e colore per sigle base
  // =========================================================
  function ui_displayLabelFor(base){
    const f = defs_effective().find(x => x.key === base);
    return f && f.sigla ? f.sigla : base;
  }
  function ui_colorForBase(base){
    const f = defs_effective().find(x => x.key === base);
    return (f && f.color) ? f.color : '#8e88ff';
  }

  // =========================================================
  // [FN: render_createCellHTML] HTML singola cella del mese
  // =========================================================
  function render_createCellHTML({day, sun, sigla, isToday, startCol}){
    const classes = ['cell']; if (sun) classes.push('sun'); if (isToday) classes.push('today');
    const startAttr = startCol ? ` style="grid-column-start:${startCol}"` : '';

    const isGLAP = (sigla === 'GL' || sigla === 'AP');
    const label  = isGLAP ? sigla : ui_displayLabelFor(sigla);
    const color  = isGLAP ? null  : ui_colorForBase(sigla);

    let siglaSpan = '';
    if (label) {
      siglaSpan = isGLAP
        ? `<span class="sigla ${sigla==='GL'?'T-GL':'T-AP'}">${label}</span>`
        : `<span class="sigla" style="color:${color}">${label}</span>`;
    }
    return `<div class="${classes.join(' ')}"${startAttr}><span class="num">${util_pad2(day)}</span>${siglaSpan}</div>`;
  }

  // =========================================================
  // [FN: render_buildMonth] Costruzione dell'intero mese
  // =========================================================
  function render_buildMonth(year,month){
    grid.innerHTML='';
    const first=new Date(Date.UTC(year,month,1));
    const last =new Date(Date.UTC(year,month+1,0));
    const lead =util_jsWeekdayUTC(first);
    monthLabel.textContent=util_fmtMonth(itMonth,year,month);

    for(let day=1; day<=last.getUTCDate(); day++){
      const d=new Date(Date.UTC(year,month,day));
      const isSun = util_jsWeekdayUTC(d)===6;
      const isT   = d.getUTCFullYear()===today.getFullYear() && d.getUTCMonth()===today.getMonth() && d.getUTCDate()===today.getDate();
      const sigla = shifts_codeForDate(d);
      const startCol = (day===1)? (lead+1) : undefined;
      grid.insertAdjacentHTML('beforeend', render_createCellHTML({day,sun:isSun,sigla,isToday:isT,startCol}));
    }
  }

  // =========================================================
  // [FN: nav_shift] Navigazione mese precedente/successivo
  // =========================================================
  function nav_shift(delta){
    view=new Date(Date.UTC(view.getUTCFullYear(), view.getUTCMonth()+delta, 1));
    render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());
  }

  // =========================================================
  // [FN: ui_switchTab] Cambio vista (calendario/impostazioni)
  // =========================================================
  function ui_switchTab(name){
    document.body.classList.toggle('hide-topbar', name==='settings');
    document.querySelectorAll('.tab').forEach(el=>el.classList.toggle('active', el.dataset.tab===name));
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(`view-${name}`).classList.add('active');
  }

  // =========================================================
  // [FN: ui_defsRenderList] Rende la lista dei turni
  // =========================================================
function ui_defsRenderList(){
  const list=defs_effective();
  const wrap=document.getElementById('turniList');
  wrap.innerHTML='';
  list.forEach((t,idx)=>{
    const row=document.createElement('div');
    row.className='settingsRow turni-grid';
    row.style.gridTemplateColumns='1fr 80px 2fr 90px 44px';
    row.style.alignItems='center';

    const p = util_splitOrario(t.orario);
    row.innerHTML = [
      `<input value="${t.nome}" data-k="nome" data-i="${idx}" />`,
      `<input value="${t.sigla}" maxlength="4" class="siglaInput" data-k="sigla" data-i="${idx}" />`,
      `<textarea class="orarioArea" data-k="orarioMultiline" data-i="${idx}" rows="2">${p.start}\n${p.end}</textarea>`,
      `<div class="colorCell"><input value="${t.color || '#8e88ff'}" class="colorInput" data-k="color" data-i="${idx}" type="color" /></div>`,
      `<button type="button" class="iconbtn iconbtn-danger" data-act="del" data-i="${idx}">✕</button>`
    ].join('');

    wrap.appendChild(row);
  });

  // Pulsante elimina
  wrap.querySelectorAll('button[data-act="del"]').forEach(b=>{
    b.addEventListener('click', ()=> ui_defsDelete(parseInt(b.dataset.i)));
  });

  // Input/textarea con aggiornamento live e a change
  wrap.querySelectorAll('input, textarea').forEach(inp=>{
    const h = ()=>{
      ui_defsEditInline(parseInt(inp.dataset.i), inp.dataset.k, inp.value);
      render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());
    };
    inp.addEventListener('input', h);
    inp.addEventListener('change', h);
  });
}


  // =========================================================
  // [FN: ui_defsAdd / ui_defsClearNew / ui_defsDelete / ui_defsEditInline]
  // CRUD dei turni
  // =========================================================
  function ui_defsAdd(){
  const nome  = document.getElementById('newNome').value.trim();
  const sigla = document.getElementById('newSigla').value.trim().toUpperCase();
  const orTxt = document.getElementById('newOrario').value; // può contenere \n
  const color = document.getElementById('newColor').value.trim() || '#8e88ff';
  if(!nome || !sigla) return;
  const orario = util_joinOrarioMultiline(orTxt);
  const list=defs_effective();
  list.push({ key:'X'+Date.now(), nome, sigla, orario, color });
  defs_save(list);
  ui_defsClearNew();
  ui_defsRenderList();
}

  function ui_defsClearNew(){
  document.getElementById('newNome').value = '';
  document.getElementById('newSigla').value = '';
  document.getElementById('newOrario').value = '';   // <-- una sola riga per orario
  document.getElementById('newColor').value = '#8e88ff';
}
  function ui_defsDelete(i){
    const list=defs_effective();
    list.splice(i,1);
    defs_save(list);
    ui_defsRenderList();
  }
  function ui_defsEditInline(i,key,val){
  const list=defs_effective();
  if(!list[i]) return;

  if(key==='orarioMultiline'){
    list[i].orario = util_joinOrarioMultiline(val);
  }else{
    list[i][key]=val;
  }
  defs_save(list);
}

  // =========================================================
  // [FN: ui_settingsInit / ui_settingsApply] Init e Salva
  // =========================================================
  function ui_settingsInit(){
    const c=settings_effective();
    document.getElementById('startDate').value=c.date;
    ui_defsRenderList();
  }
  function ui_settingsApply(){
    const date=document.getElementById('startDate').value;
    const shift=settings_effective().shift || 'S';
    settings_save({date,shift});
    render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());
  }

  // =========================================================
  // [FN: boot_init] Avvio app
  // =========================================================
  function boot_init(){
  const fmt=new Intl.DateTimeFormat('it-IT',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  const f=fmt.format(new Date());
  document.getElementById('todayHeader').textContent=f.charAt(0).toUpperCase()+f.slice(1);

  // Navigazione calendario
  document.getElementById('prev').addEventListener('click', ()=>nav_shift(-1));
  document.getElementById('next').addEventListener('click', ()=>nav_shift(1));

  // Cambio tab
  document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click', ()=>ui_switchTab(t.dataset.tab)));

  // Impostazioni
document.getElementById('btnAddTurno').addEventListener('click', ui_defsAdd);

const btnSaveCloud  = document.getElementById('btnSaveCloud');
const btnImportCloud= document.getElementById('btnImportCloud');
if(btnSaveCloud)   btnSaveCloud.addEventListener('click', storage_saveToDropbox);
if(btnImportCloud) btnImportCloud.addEventListener('click', storage_importFromDropbox);

  // Placeholder multilinea coerente ovunque
  document.getElementById('newOrario').placeholder = "00:00\n00:00";

  // >>> QUI: bind icone e stato Dropbox all’avvio <<<
  dbx_bindIconClicks();
  dbx_updateIcons(); // allinea lo stato delle icone al boot

  // Init UI
  ui_settingsInit();
  render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());
}


// =======================================================
// [BLOCK: DROPBOX PKCE HELPERS] – Fase 8
// =======================================================
function generateCodeVerifier() {
  const array = new Uint8Array(32);
  window.crypto.getRandomValues(array);
  return btoa(String.fromCharCode(...array))
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=+$/, "");
}

async function generateCodeChallenge(verifier) {
  const data = new TextEncoder().encode(verifier);
  const digest = await window.crypto.subtle.digest("SHA-256", data);
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=+$/, "");
}


// =======================================================
// [BLOCK: DROPBOX AUTH INIT] – Fase 7 (FIX async/PKCE)
// =======================================================

async function startDropboxAuth() {
  try {
    const verifier  = generateCodeVerifier();
    const challenge = await generateCodeChallenge(verifier); // <-- QUI il punto chiave
    localStorage.setItem("dbx_code_verifier", verifier);

    const params = new URLSearchParams({
      response_type: "code",
      client_id: DROPBOX_APP_KEY,
      redirect_uri: DROPBOX_REDIRECT,
      token_access_type: "offline",
      code_challenge_method: "S256",
      code_challenge: challenge
    });

    window.location.href = `https://www.dropbox.com/oauth2/authorize?${params.toString()}`;
  } catch (e) {
    const el = document.getElementById("dropboxStatus");
    if (el) el.textContent = "Errore locale nell'avvio PKCE";
  }
}


// =======================================================
// [BLOCK: DROPBOX STATUS] – Fase 8
// =======================================================
function updateDropboxStatus() {
  const token = localStorage.getItem("dropbox_token");
  const el = document.getElementById("dropboxStatus");
  if (token) {
    el.textContent = "✅ Connesso a Dropbox";
  } else {
    el.textContent = "❌ Non collegato";
  }
}
updateDropboxStatus();

// =======================================================
// [BLOCK: DROPBOX UI HELPERS] Stato icone + modale
// =======================================================
function dbx_isConnected(){
  return !!localStorage.getItem("dropbox_token");
}
function dbx_updateIcons(){
  const on = dbx_isConnected();
  const h  = document.getElementById("dbxIconHeader");
  const s  = document.getElementById("dbxIconSettings");
  const st = document.getElementById("dropboxStatus");
  const dis= document.getElementById("dbxDisconnect");

  [h,s].forEach(el => {
    if(!el) return;
    el.classList.toggle("dbx-on",  on);
    el.classList.toggle("dbx-off", !on);
  });

  if(st) st.textContent = on ? "✅ Connesso a Dropbox" : "❌ Non collegato";

  if(dis){
    dis.style.display = on ? "inline-flex" : "none";
  }
}


function dbx_openModal(show){
  const m = document.getElementById("dbxModal");
  if(!m) return;
  m.classList.toggle("active", !!show);

  // Aggiorna copy del modale in base alla modalità
  const body = m.querySelector('.modalBody');
  if(body){
    if(isStandaloneDisplayMode()){
      body.textContent = "Verrai reindirizzato a una pagina di Dropbox per l’autorizzazione. Dopo il collegamento tornerai al calendario.";
    }else{
      body.textContent = "Verrà aperta una finestra di Dropbox per l’autorizzazione. Dopo il collegamento, tornerai al calendario.";
    }
  }
}

// =======================================================
// [DBX LOW-LEVEL HELPERS] chiamate API
// =======================================================
function dbx_token(){
  return localStorage.getItem("dropbox_token") || "";
}

async function dbx_api(path, bodyObj){
  const res = await fetch("https://api.dropboxapi.com/2" + path, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer " + dbx_token()
    },
    body: JSON.stringify(bodyObj||{})
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error(`Dropbox API ${path} failed: ${res.status} ${t}`);
  }
  return res.json();
}

// Upload binario (files/upload su content.dropboxapi.com)
async function dbx_upload(filepath, uint8){
  const args = {
    path: filepath,
    mode: "overwrite",
    autorename: false,
    mute: true
  };
  const res = await fetch("https://content.dropboxapi.com/2/files/upload", {
    method:"POST",
    headers:{
      "Authorization":"Bearer " + dbx_token(),
      "Dropbox-API-Arg": JSON.stringify(args),
      "Content-Type":"application/octet-stream"
    },
    body: uint8
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error(`Dropbox upload failed: ${res.status} ${t}`);
  }
  return res.json();
}

async function dbx_download(filepath){
  const res = await fetch("https://content.dropboxapi.com/2/files/download", {
    method:"POST",
    headers:{
      "Authorization":"Bearer " + dbx_token(),
      "Dropbox-API-Arg": JSON.stringify({ path: filepath })
    }
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error(`Dropbox download failed: ${res.status} ${t}`);
  }
  const text = await res.text();
  return text;
}

// Crea cartella se non esiste. Restituisce true se già esiste o creata.
async function dbx_ensureFolder(folderPath){
  // Se esiste, bene; se 409 path/not_found, la creiamo.
  try{
    await dbx_api("/files/get_metadata", { path: folderPath });
    return true;
  }catch(e){
    // prova a creare
    try{
      await dbx_api("/files/create_folder_v2", { path: folderPath, autorename:false });
      return true;
    }catch(err){
      // Se è un app-folder, la root è già "Apps/<AppName>" e non puoi usare "/Apps/.."
      // Fallback: prova senza /Apps
      if(String(err).includes("path/not_found") || String(err).includes("path/restricted_content")){
        return false;
      }
      throw err;
    }
  }
}

// =======================================================
// [STORAGE SAVE/IMPORT] Logica alto livello (cartella fissa /Apps/turni)
// =======================================================
async function storage_saveToDropbox(){
  if(!dbx_isConnected()){
    alert("Non sei connesso a Dropbox.");
    return;
  }

  ui_settingsApply();

  const payload = storage_buildPayload();
  const jsonStr  = JSON.stringify(payload, null, 2);
  const bytes    = new TextEncoder().encode(jsonStr);
  const fname    = storage_buildFilename();

  const base = "/Apps/turni";
  await dbx_ensureFolder(base);
  const path = `${base}/${fname}`;

  try{
    await dbx_upload(path, bytes);
    const st = document.getElementById("dropboxStatus");
    if(st) st.textContent = `✅ Salvato: ${path}`;
  }catch(e){
    alert("Errore nel salvataggio su Dropbox.");
    console.error(e);
  }
}


async function storage_importFromDropbox(){
  if(!dbx_isConnected()){
    alert("Non sei connesso a Dropbox.");
    return;
  }

  const fname = storage_buildFilename();
  const path  = `/Apps/turni/${fname}`;

  try{
    const text = await dbx_download(path);
    const obj  = JSON.parse(text);

    if(obj.settings) settings_save(obj.settings);
    if(Array.isArray(obj.defs)) defs_save(obj.defs);

    ui_settingsInit();
    render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());

    const st = document.getElementById("dropboxStatus");
    if(st) st.textContent = `✅ Importato da: ${path}`;
  }catch(e){
    alert("Errore nell’importazione da Dropbox o file non trovato.");
    console.error(e);
  }
}



// =======================================================
// [BLOCK: DROPBOX DISCONNECT] Pulisce token e aggiorna UI
// =======================================================
function dbx_disconnect(){
  // Conferma leggera
  const ok = confirm("Vuoi disconnettere l'app da Dropbox?");
  if(!ok) return;

  try{
    localStorage.removeItem("dropbox_token");
    localStorage.removeItem("dbx_code_verifier");
  }catch{}

  dbx_updateIcons();                // aggiorna icone/stato
  ui_switchTab("settings");         // resta in impostazioni
  const st = document.getElementById("dropboxStatus");
  if(st){ st.textContent = "❌ Non collegato"; }
}


/// =======================================================
// [BLOCK: DROPBOX AUTH SMART] Popup quando possibile, altrimenti full redirect
// =======================================================
const DROPBOX_APP_KEY = "2aw9gg2ov9tmzuc";
const DROPBOX_REDIRECT = "https://galabor.github.io/turni-pds/redirect";

let dbxPopupRef = null;

function isStandaloneDisplayMode(){
  // iOS: navigator.standalone; PWA generico: media query display-mode
  return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches)
         || (window.navigator && window.navigator.standalone === true);
}

async function dbx_startAuthSmart(){
  try{
    const verifier  = generateCodeVerifier();
    const challenge = await generateCodeChallenge(verifier);
    localStorage.setItem("dbx_code_verifier", verifier);

    const params = new URLSearchParams({
      response_type:"code",
      client_id: DROPBOX_APP_KEY,
      redirect_uri: DROPBOX_REDIRECT,
      token_access_type:"offline",
      code_challenge_method:"S256",
      code_challenge: challenge
    });
    const authUrl = `https://www.dropbox.com/oauth2/authorize?${params.toString()}`;

    // In modalità standalone / iOS Add-to-Home o se i popup sono bloccati → redirect pieno
    if (isStandaloneDisplayMode()) {
      window.location.href = authUrl;
      return;
    }

    // Popup centrato in modo robusto (compatibile multi-monitor e Safari)
const W = 520, H = 680;
const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : screen.left;
const dualScreenTop  = window.screenTop  !== undefined ? window.screenTop  : screen.top;

const width  = window.innerWidth  ? window.innerWidth  : document.documentElement.clientWidth  ? document.documentElement.clientWidth  : screen.width;
const height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;

const left = ((width  - W) / 2) + dualScreenLeft;
const top  = ((height - H) / 2) + dualScreenTop;

dbxPopupRef = window.open(
  authUrl,
  "dbx_auth",
  `scrollbars=yes,width=${W},height=${H},top=${top},left=${left}`
);


    // Fallback: se il popup è nullo/subito chiuso, vai di redirect
    setTimeout(()=>{
      if(!dbxPopupRef || dbxPopupRef.closed){
        window.location.href = authUrl;
      }
    }, 400);
  }catch(e){
    const st = document.getElementById("dropboxStatus");
    if(st) st.textContent = "Errore nell’avvio del collegamento.";
  }
}

// Bind pulsanti icona + modale
function dbx_bindIconClicks(){
  const h = document.getElementById("dbxIconHeader");
  const s = document.getElementById("dbxIconSettings");
  [h,s].forEach(el=>{
    if(!el) return;
    el.addEventListener("click", ()=>{
      if(dbx_isConnected()){
        return; // già collegato
      }
      dbx_openModal(true);
    });
  });

  // Pulsante Disconnetti
  const dis = document.getElementById("dbxDisconnect");
  if(dis) dis.addEventListener("click", dbx_disconnect);

  // Modale: avanti/chiudi
  const go = document.getElementById("dbxModalGo");
  const cl = document.getElementById("dbxModalClose");
  if(go) go.addEventListener("click", ()=>{ dbx_openModal(false); dbx_startAuthSmart(); });
  if(cl) cl.addEventListener("click", ()=> dbx_openModal(false));
}


// Ricezione esito da redirect.html + sync storage cross-window
(function(){
// Origini attendibili (GitHub Pages)
  const ALLOWED_ORIGINS = ["https://galabor.github.io"];

  // Messaggio dal popup: token salvato → aggiorna UI, chiudi, torna al calendario
  window.addEventListener("message",(ev)=>{
    if(!ALLOWED_ORIGINS.includes(ev.origin)) return;
    if(ev.data === "DBX_OK"){
      dbx_updateIcons();
      if(dbxPopupRef && !dbxPopupRef.closed) dbxPopupRef.close();
      ui_switchTab("calendar");
    }
  });

  // Evento storage: se un’altra window salva dropbox_token, aggiorna le icone live
  window.addEventListener("storage",(ev)=>{
    if(ev.key === "dropbox_token"){
      dbx_updateIcons();
    }
  });
})();



  // =========================================================
// [BLOCK: BOOTSTRAP] DOM ready
// =========================================================
if (document.readyState === 'loading') {
  window.addEventListener('DOMContentLoaded', boot_init);
} else {
  boot_init();
}

// =========================================================
// [SERVICE WORKER] – registrazione con auto-update
// =========================================================
(function(){
  if (!('serviceWorker' in navigator)) return;

  // Allinea il ?v=... a quello del SW (basta lo stesso numero finale)
  const SW_VERSION = '2025-10-22-03';
  const SW_URL = `/turni-pds/service-worker.js?v=${SW_VERSION}`;

  async function registerSW(){
    try{
      const reg = await navigator.serviceWorker.register(SW_URL, { scope: '/turni-pds/' });

      // Se c'è già un worker "waiting", chiedi di attivarsi
      if (reg.waiting) {
        reg.waiting.postMessage({ type: 'SKIP_WAITING' });
      }

      // Quando arriva un nuovo SW (installing), aspetta "installed" e poi promuovilo subito
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        if (!nw) return;
        nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            nw.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });

      // Quando il controller cambia, significa che il nuovo SW è attivo: ricarica l’app
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        // Evita loop: ricarica una sola volta
        if (!window.__reloadedForSW) {
          window.__reloadedForSW = true;
          location.reload();
        }
      });

      // Piccolo “tiramisù” periodico: controlla update all’avvio e quando torni in focus
      reg.update().catch(()=>{});
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          reg.update().catch(()=>{});
        }
      });

    }catch(e){
      // pace
    }
  }

  // Registra appena possibile (più affidabile di 'load' sulle PWA installate)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', registerSW);
  } else {
    registerSW();
  }
})();


</script>


</body>
</html>
