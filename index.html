<!-- ======================= -->
<!-- inizio html            -->
<!-- ======================= -->
<!doctype html>
<html lang="it">

<!-- ======================= -->
<!-- inizio head            -->
<!-- ======================= -->
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Canonicalizza l’URL su /turni-pds/ ed evita il BFCache zombie -->
  <script>
  (function(){
    var p = location.pathname;
    if (p === '/turni-pds' || p === '/turni-pds/index.html') {
      location.replace('/turni-pds/');
    }
  })();
  </script>

  <!-- Spingi i browser a non cacheare l'HTML -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>Turni Polizia di Stato</title>

<!-- Manifest + ICONS (iniezione dinamica base-aware) -->
<script>
(function () {
  var BASE = (location.hostname === "localhost") ? "" : "/turni-pds";

  // 1) Manifest
  var m = document.createElement("link");
  m.rel = "manifest";
  m.href = BASE + "/manifest.webmanifest";
  document.head.appendChild(m);

  // 2) Favicon + PWA + Apple
  var links = [
    // favicon per TAB
    { rel: "icon", type: "image/png", sizes: "16x16", href: BASE + "/ico/favicon-16x16.png" },
    { rel: "icon", type: "image/png", sizes: "32x32", href: BASE + "/ico/favicon-32x32.png" },
    { rel: "icon", type: "image/x-icon",               href: BASE + "/ico/favicon.ico"       },
    { rel: "shortcut icon",                             href: BASE + "/ico/favicon.ico"       },

    // Apple touch (iOS usa queste, non il manifest)
    { rel: "apple-touch-icon", sizes: "180x180", href: BASE + "/ico/apple-touch-icon-180x180.png" },

    // PWA large icons (non per la tab, utili per install)
    { rel: "icon", type: "image/png", sizes: "192x192", href: BASE + "/ico/icon-192.png" },
    { rel: "icon", type: "image/png", sizes: "512x512", href: BASE + "/ico/icon-512.png" }
  ];
  links.forEach(function (def) {
    var el = document.createElement("link");
    for (var k in def) el.setAttribute(k, def[k]);
    document.head.appendChild(el);
  });

  // 3) Fallback per Edge in locale: alcuni chiedono /favicon.ico alla root
  if (location.hostname === "localhost") {
    var f = document.createElement("link");
    f.setAttribute("rel", "icon");
    f.setAttribute("href", "/favicon.ico");
    document.head.appendChild(f);
  }
})();
</script>



  <!-- Colore tema -->
  <meta name="theme-color" content="#387cff">

  <script src="https://accounts.google.com/gsi/client" async defer></script>


  <style>
  /* ====== TUTTI I TUOI STILI INVARIATI (copiati 1:1) ====== */

  /* =========================================================
     [CSS-ROOT] Variabili tema e dimensioni standard
     ========================================================= */
  :root{
    --iosBlue:#1976d2; --iosBlue-600:#1565c0;
    --bg:#f3f5f8; --card:#ffffff; --gridBorder:#d9dee6;
    --text:#0b1320; --muted:#7a8595;
    --sunday:#c62828; --today:#cfe3ff;
    --T-GL:#c68bcf; --T-AP:#a47ac9;      /* colori fissi GL/AP */
    --fieldH:44px;                        /* altezza campi impostazioni */

    /* === Glow vars (topbar + background) === */
    --bar-h: 60px;     /* verrà aggiornato via JS all’altezza reale della tua topbar */
    --seam: 20px;      /* lunghezza dissolvenza sotto la topbar */
    --blue-rgb: 25,118,210; /* il tuo iosBlue in RGB */

    --cx: 50%;
    --cy: 50%;
    --glow-x: 50%;

    --core-a1: 0.94; --core-a2: 0.82; --core-a3: 0.66; --core-a4: 0.48; --core-a5: 0.34;
    --mid-a1: 0.18;  --mid-a2: 0.12;  --mid-a3: 0.08;
    --far-a1: 0.08;  --far-a2: 0.05;  --far-a3: 0.024;
    --tail: color-mix(in oklch, rgb(var(--blue-rgb)) 0%, var(--bg) 100%);
  }

  /* =========================================================
     [CSS-BASE] Reset e tipografia
     ========================================================= */
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,"Helvetica Neue",Arial}

  /* =========================================================
   [CSS-TOPBAR] Barra blu con glow continuo (misure invariabili)
   ========================================================= */
  .topbar{
    position: sticky;
    top: 0;
    z-index: 20;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
    padding: 10px 12px;
    color: #fff;
    background: transparent;
    will-change: transform;
    transform: translateZ(0);
    backface-visibility: hidden;
    contain: paint;
    overflow: visible;
    box-shadow:
      inset 0 -1px 0 var(--bg),
      inset 0  1px 0 var(--bg);
  }
  /* Omino nella topbar, allineato a destra */
  .topbar-right{
    position:absolute;
    right:12px;
    top:50%;
    transform:translateY(-50%);
    display:flex;
    align-items:center;
    gap:6px;
  }

/* ========== [CSS-ACCOUNT MENU] ========== */
.acct-menu{
  position: fixed;                 /* resta nel body (portaled) */
  left: -9999px;
  top:  -9999px;
  display: none;                   /* gestito da .show */
  z-index: 2147483647;             /* sopra tutto */
  min-width: 220px;
  background: var(--surface-opaque, #0f141b);
  border: 1px solid var(--gridBorder);
  border-radius: 12px;
  padding: 6px;
  box-shadow:
    0 12px 28px rgba(0,0,0,.45),
    inset 0 1px 0 rgba(255,255,255,.03);
  transform-origin: top right;
  transform: scale(.985);
  opacity: 0;
  transition:
    transform .12s ease-out,
    opacity   .12s ease-out,
    box-shadow .18s ease;
}
.acct-menu.show{
  display:block;
  opacity:1;
  transform: scale(1);
}

/* Effetto glow/fade per apertura */
.acct-menu{
  transition:
    opacity .22s ease,
    transform .22s cubic-bezier(.2,.8,.3,1);
  transform: translateY(4px) scale(.985);
  opacity: 0;
}
.acct-menu.show{
  opacity: 1;
  transform: translateY(0) scale(1);
  box-shadow:
    0 20px 45px rgba(0,0,0,.5),
    0 0 0 1px rgba(255,255,255,.05);
}

/* Sheen sottile sulle voci */
.acct-item{
  position: relative;
  overflow: hidden;
}
.acct-item::after{
  content:"";
  position:absolute;
  left:-80%; top:0;
  width:60%; height:100%;
  background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,.25) 50%,transparent 100%);
  transform:skewX(-20deg);
  opacity:0;
  transition:all .3s ease;
}
.acct-item:hover::after{
  left:130%;
  opacity:.6;
}

/* Glow morbido sullo stato verde */
.acct-head-status.is-on{
  border-color:rgba(46,204,113,.5);
  background:rgba(46,204,113,.14);
  color:#b6f5d0;
  box-shadow:0 0 12px rgba(46,204,113,.25);
}

/* Testatina del menu: titolo + stato */
.acct-head{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:12px;
  padding:8px 10px 6px;
  border-radius:8px;
  background:
    linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
}
.acct-head-title{
  font-weight:700;
  letter-spacing:.2px;
  font-size:.92rem;
  color:var(--text);
}
.acct-head-status{
  font-size:.75rem;
  font-weight:700;
  letter-spacing:.25px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid var(--gridBorder);
  background: rgba(255,255,255,.06);
  color: var(--muted);
  white-space:nowrap;
}
/* (Step 3 useremo queste due classi) */
.acct-head-status.is-on{
  border-color: rgba(46,204,113,.35);
  background: rgba(46,204,113,.12);
  color: #9be2b8;
}
.acct-head-status.is-off{
  border-color: rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  color: var(--muted);
}

.acct-sep{
  height:0;
  border-top:1px solid var(--gridBorder);
  margin:6px 0;
}

/* Voci */
.acct-item{
  width:100%;
  appearance:none;
  border:0;
  background:transparent;
  color:var(--text);
  font-weight:600;
  font-size:.92rem;
  letter-spacing:.2px;
  text-align:left;
  padding:9px 10px;
  border-radius:8px;
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;
  transition:
    background .16s ease,
    box-shadow .16s ease,
    transform .06s ease;
}
.acct-item:hover{
  background: var(--actHover);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
}
.acct-item:active{
  background: var(--actActive);
  transform: translateY(1px);
}
.acct-item.danger{ color:#ff6b6b; }
.acct-item.danger:hover{
  background: rgba(255,80,80,.12);
  box-shadow: inset 0 0 0 1px rgba(255,80,80,.18);
}

/* Icona omino nel topbar */
#acctBtnHeader{
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}
#acctBtnHeader svg{
  width: 28px;
  height: 28px;
  transition: transform .18s ease;
}
#acctBtnHeader:hover svg{ transform: translateZ(0) scale(1.05); }

/* Desktop: omino leggermente più grande */
@media (min-width: 720px) {
  #acctBtnHeader svg{ width: 32px; height: 32px; }
}

/* Badge stato */
.acct-badge{
  position:absolute;
  right:1px;
  bottom:1px;
  width:7px;
  height:7px;
  border-radius:50%;
  background:#2ecc71;
  box-shadow:0 0 2px rgba(46,204,113,.55);
  transform:translate(1px,1px);
}
.acct-badge.off{
  background:#9ba4b0;
  box-shadow:none;
  opacity:.85;
}

  .topbar::before{
    content: "";
    position: absolute;
    left: 0; right: 0; top: 0;
    height: calc(var(--bar-h) + var(--seam) + 2px);
    pointer-events: none;
    background:
      linear-gradient(to right,
        var(--bg) 0%,
        color-mix(in oklch, var(--bg) 85%, transparent) 8%,
        transparent 18%,
        transparent 82%,
        color-mix(in oklch, var(--bg) 85%, transparent) 92%,
        var(--bg) 100%
      ),
      radial-gradient(
        ellipse 85% 160% at var(--cx) var(--cy),
        rgba(var(--blue-rgb), var(--far-a1)) 0%,
        rgba(var(--blue-rgb), var(--far-a2)) 32%,
        rgba(var(--blue-rgb), var(--far-a3)) 62%,
        var(--tail) 100%
      ),
      radial-gradient(
        ellipse 60% 130% at var(--cx) var(--cy),
        rgba(var(--blue-rgb), var(--mid-a1)) 0%,
        rgba(var(--blue-rgb), var(--mid-a2)) 26%,
        rgba(var(--blue-rgb), var(--mid-a3)) 56%,
        var(--tail) 100%
      ),
      radial-gradient(
        ellipse var(--glow-x) 120% at var(--cx) var(--cy),
        rgba(var(--blue-rgb), 1) 0%,
        rgba(var(--blue-rgb), var(--core-a1)) 8%,
        rgba(var(--blue-rgb), var(--core-a2)) 14%,
        rgba(var(--blue-rgb), var(--core-a3)) 22%,
        rgba(var(--blue-rgb), var(--core-a4)) 32%,
        rgba(var(--blue-rgb), var(--core-a5)) 44%,
        rgba(var(--blue-rgb), 0.12) 62%,
        rgba(var(--blue-rgb), 0.06) 78%,
        var(--tail) 100%
      );
    -webkit-mask-image:
      linear-gradient(to bottom,
        #000 0,
        #000 var(--bar-h),
        rgba(0,0,0,0.65) calc(var(--bar-h) + var(--seam) * .35),
        rgba(0,0,0,0.28) calc(var(--bar-h) + var(--seam) * .75),
        transparent           calc(var(--bar-h) + var(--seam))
      );
    mask-image:
      linear-gradient(to bottom,
        #000 0,
        #000 var(--bar-h),
        rgba(0,0,0,0.65) calc(var(--bar-h) + var(--seam) * .35),
        rgba(0,0,0,0.28) calc(var(--bar-h) + var(--seam) * .75),
        transparent           calc(var(--bar-h) + var(--seam))
      );
  }
  .todayDate{
    font-size: 0.9rem;
    text-align: center;
    color: var(--muted);
    margin-top: 6px;
    position: relative;
    z-index: 1;
  }
  .brandmark{
    display:flex;
    align-items:center;
    justify-content:center;
    line-height:0;
  }
  .brandmark svg{
    display:block;
    height:24px;
    width:auto;
    transform: scale(var(--wmScale, 1.80));
    transform-origin: center;
  }

  /* =========================================================
   [CSS-LAYOUT] Main, barra mese, intestazioni giorni
   ========================================================= */
  main{ max-width:760px; margin:8px auto 90px; padding:0 10px; }
  .monthbar{
    display:grid; grid-template-columns:auto 1fr auto;
    align-items:center; gap:8px; margin:10px 0 6px;
  }
  .monthbar .title{ text-align:center }

  /* Frecce mese stile icone (tab/btn) */
.navbtn{
  appearance:none;
  border:0;
  background:transparent;
  color:var(--actColor);               /* stesso colore icone */
  font-size:22px;
  line-height:1;
  cursor:pointer;
  padding:6px 8px;
  border-radius:10px;
  -webkit-tap-highlight-color:transparent;
  transition: background .18s ease, color .18s ease, transform .06s ease;
}

.navbtn:hover{
  background:var(--actHover);          /* alone morbido */
  color:var(--actColorHi);             /* highlight come icone */
  transform:translateY(-1px);
}

.navbtn:active{
  background:var(--actActive);         /* click feedback */
  color:var(--actColorHi);
  transform:translateY(1px);
}


  .weekhead{
    display:grid; grid-template-columns:repeat(7,1fr);
    gap:3px; padding:3px 3px 0;
  }

  html, body { height: 100%; }
  body.no-scroll { overflow: hidden; }
  body.no-scroll main{ margin-bottom: calc(var(--tabH) + 12px); overflow: clip; }
  .view{ display:none } .view.active{ display:block }

  /* =========================================================
   [CSS-CALENDAR GRID]
   ========================================================= */
.grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  grid-auto-rows:minmax(62px,1fr);
  gap:3px;
  padding:3px;
}
.cell{
  position:relative;
  min-height:84px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.cell::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  background:transparent;
  transition:background .18s ease;
  pointer-events:none;
}
.num{
  position:absolute;
  left:8px;
  top:6px;
  font-size:18px;
  color:var(--muted);
  font-weight:800;
  z-index:1;
}
.sun .num{ color:var(--sunday); }
.sigla{
  font-size:23px;
  font-weight:400;
  letter-spacing:.5px;
  opacity:.95;
  position:relative;
  top:8px;
  z-index:1;
}
.T-GL{ color:var(--T-GL); }
.T-AP{ color:var(--T-AP); }
.cell:hover::before{ background:var(--actHover); }
.cell:active::before{ background:var(--actActive); }
.cell.selected::before{ background:var(--actActive); }

@media(max-width:560px){
  .grid{ grid-auto-rows:minmax(48px,1fr); }
  .cell{ min-height:auto; padding:4px 0; }

  .num{
    font-size:15px;                /* più grande e nitido */
    font-weight:800;               /* ritorna al peso pieno */
    top:4px;
    color:var(--text);             /* più contrastato */
    line-height:1;
    -webkit-text-stroke:0.15px transparent;
    -webkit-font-smoothing:antialiased;
    text-rendering:optimizeLegibility;
  }

  .sigla{
    font-size:18px;
    top:9px;
    opacity:.9;
  }
}


  /* =========================================================
     [CSS-SETTINGS CARD]
     ========================================================= */
  .settingsCard{background:var(--card);border:1px solid var(--gridBorder);border-radius:10px;padding:14px;margin-top:10px}
  .settingsRow{display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center;margin:8px 0}
  .settingsRow label{font-weight:600;color:var(--muted)}
  .settingsRow input,.settingsRow select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--gridBorder);background:var(--card);color:var(--text);height:var(--fieldH)}
  .savebtn{margin-top:12px;padding:10px 14px;border:0;border-radius:10px;background:var(--iosBlue);color:#fff;font-weight:700;cursor:pointer}

  /* =========================================================
     [CSS-TABBAR]
     ========================================================= */
  .tabbar{
    position:fixed; bottom:0; left:0; right:0;
    background:var(--card); border-top:1px solid var(--gridBorder);
    display:flex; justify-content:space-around; gap:10px;
    padding:8px 10px; z-index:10;
  }
  :root{
    --tabW: 56px; --tabH: 46px; --tabIcon: 22px;
    --tabColor: #b7bcc6; --tabColorActive: #e3e7ec;
    --tabHoverBg: rgba(255,255,255,.10); --tabActiveBg: rgba(255,255,255,.14);
  }
  .tab{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
    width:var(--tabW); height:var(--tabH); border-radius:12px; background:transparent;
    color:var(--tabColor); font-size:12px; cursor:pointer; -webkit-tap-highlight-color:transparent;
    transition: background-color .18s ease, color .18s ease, transform .06s ease;
  }
  .tab svg{ width:var(--tabIcon); height:var(--tabIcon); display:block; fill:none; stroke:currentColor; stroke-width:2.25; stroke-linecap:round; stroke-linejoin:round; }
  .tab.active{ color:var(--tabColorActive); background:var(--tabActiveBg); font-weight:700; }
  .tab:hover{ background:var(--tabHoverBg); color:var(--tabColorActive); transform:translateY(-1px); }
  .tab:active{ background:var(--tabActiveBg); transform:translateY(1px); }
  .tab span{ line-height:1; }
  @media (max-width:560px){
    :root{ --tabW: 48px; --tabH: 40px; --tabIcon: 18px; }
  }

  /* =========================================================
     [CSS-FORMS TWEAKS]
     ========================================================= */
  .thin-sep{height:0;border-top:1px solid var(--gridBorder);margin:6px 0}
  .iconbtn{width:var(--fieldH);height:var(--fieldH);border-radius:8px;padding:0;font-size:20px;display:flex;align-items:center;justify-content:center;border:0}
  .iconbtn-primary{background:var(--iosBlue);color:#fff}
  .iconbtn-danger{background:#b42325;color:#fff}
  .iconbtn:active{transform:translateY(1px)}
  @media(max-width:560px){ .settingsRow{grid-template-columns:120px 1fr} }
  .hide-topbar .topbar, .hide-topbar #todayHeaderRow{ display: none !important; }
  .hide-topbar main{ margin-top: 8px; }

  /* =========================================================
     [CSS-COLOR PICKER]
     ========================================================= */
  .colorCell{ display:flex; align-items:center; justify-content:center; }
  .colorInput{
    -webkit-appearance:none; appearance:none;
    box-sizing:border-box; width:var(--fieldH); height:var(--fieldH);
    aspect-ratio:1/1; padding:0; margin:0;
    border:1px solid var(--gridBorder); border-radius:8px;
    background:transparent; min-width:0; line-height:normal;
  }
  .colorInput::-webkit-color-swatch-wrapper{ padding:0; }
  .colorInput::-webkit-color-swatch{ border:none; border-radius:6px; }
  .colorInput::-moz-color-swatch{ border:none; border-radius:6px; }
  @media (max-width:560px){ :root{ --fieldH:40px; } }

  /* =========================================================
   [CSS-GRID TURNI OVERRIDE v4]
   ========================================================= */
  .turni-grid{ grid-template-columns: 1fr 64px 1.05fr 52px 44px !important; align-items:center; }
  .siglaInput{ width:100%; max-width:none; text-transform:uppercase; text-align:center; letter-spacing:0.5px; }
  @media (max-width:560px){
    .turni-grid{ grid-template-columns: 1fr 60px 0.85fr 46px 44px !important; }
    .siglaInput{ width:100%; }
  }

  /* =========================================================
   [CSS-APP DATE FIELD v3]
   ========================================================= */
  .settingsRow input[type="date"]{
    width:95%; min-width:0; font-size:1rem; height:38px; line-height:38px;
    text-align:center; margin:0 auto; display:block; box-sizing:border-box; border-radius:8px;
  }
  @media (max-width:560px){
    .settingsRow input[type="date"]{
      width:92%; font-size:1.05rem; height:36px; line-height:36px;
    }
  }

  /* =========================================================
   [CSS-ORARIO MULTILINEA]
   ========================================================= */
  .orarioArea{
    display:block; width:100%; min-width:0; height:calc(var(--fieldH) + 2px);
    padding:6px 8px; resize:none; line-height:1.05; font-size:0.86rem;
    border:1px solid var(--gridBorder); border-radius:8px; background:var(--card); color:var(--text);
    box-sizing:border-box; white-space:pre;
  }
  @media (max-width:560px){ .orarioArea{ font-size:0.8rem; height:calc(var(--fieldH)); } }
  @media (max-width:560px){ .settingsRow{ gap:6px; } .turni-grid > div:first-child input{ padding-left:8px; } }

  /* =========================================================
   [CSS-DROPBOX UI] (RIUSATO PER L’OMINO GOOGLE, NON TOCCATO)
   ========================================================= */
  .dropboxIconBtn{
    display:inline-flex; align-items:center; justify-content:center;
    width:36px; height:36px; margin-left:8px; cursor:pointer;
    border-radius:6px; border:1px solid transparent; background:transparent;
  }
  .dropboxIconBtn:hover,
  .dropboxIconBtn:focus,
  .dropboxIconBtn:active{ background:transparent; border-color:transparent; box-shadow:none; }
  .dropboxIconBtn svg{ display:block; width:22px; height:22px; background:transparent; }
  #dbxIconHeader svg{ width:28px; height:28px; }
  .dropboxIconBtn:active{ transform:translateY(1px); }
  .dbx-off{ color: var(--muted); }
  .dbx-off svg path{ fill: currentColor; }
  .dbx-on{ color: var(--iosBlue); }
  .dbx-on svg path{ fill: currentColor; }

  .modalBackdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35);
    display:none; align-items:center; justify-content:center; z-index:50; }
  .modalBackdrop.active{ display:flex; }
  .modalCard{ width:min(480px, 92vw); background:var(--card); border:1px solid var(--gridBorder);
    border-radius:12px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.25); }
  .modalHeader{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .modalTitle{ font-weight:700; }
  .modalBody{ margin-top:10px; color:var(--muted); }
  .modalActions{ margin-top:14px; display:flex; gap:8px; justify-content:flex-end; }

  .textbtn{ appearance:none; border:1px solid var(--gridBorder); background:transparent; color:var(--text);
    padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:.92rem; }
  .textbtn:active{ transform:translateY(1px); }
  .textbtn-danger{ border-color:#b42325; color:#b42325; }
  .textbtn-danger:active{ border-color:#96201f; }

  .actionIcons{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  .btn-icon{
    display:inline-flex; align-items:center; justify-content:center;
    width:var(--actBtn); height:var(--actBtn); padding:0; border:none; border-radius:12px;
    background:transparent; color:var(--actColor); cursor:pointer;
    transition: background .18s ease, color .18s ease, transform .06s ease;
  }
  .btn-icon:hover{ background:var(--actHover); color:var(--actColorHi); transform:translateY(-1px); }
  .btn-icon:active{ background:var(--actActive); color:var(--actColorHi); transform:translateY(1px); }
  .btn-icon svg{ width:var(--actIcon); height:var(--actIcon); display:block; flex-shrink:0; stroke:currentColor; fill:none; }
  .btn-icon svg, .btn-icon svg *{ stroke-linecap:round; stroke-linejoin:round; stroke-width:var(--actStroke); vector-effect:non-scaling-stroke; stroke-opacity:1; }
  .btn-icon span{ display:none; }
  @media (max-width:560px){
    :root{ --actBtn:40px; --actIcon:22px; --actStroke:2px; }
  }

  .dither{ position: fixed; inset: 0; z-index: 2; pointer-events: none; opacity: .04; mix-blend-mode: multiply; display: none;
    background:
      repeating-linear-gradient(  0deg, rgba(0,0,0,.03) 0 1px, transparent 1px 2px),
      repeating-linear-gradient( 90deg, rgba(0,0,0,.03) 0 1px, transparent 1px 2px),
      repeating-linear-gradient( 45deg, rgba(0,0,0,.02) 0 1px, transparent 1px 2px),
      repeating-linear-gradient(-45deg, rgba(0,0,0,.02) 0 1px, transparent 1px 2px);
  }
  @media (prefers-color-scheme: light){ .dither{ display: block; } }

  /* =========================================================
     [THEME] Moderno 2025 — Neo-Glass Soft
     ========================================================= */
  :root{
    --bg:
      radial-gradient(1100px 640px at 50% -12%,
        rgba(56, 124, 255, .22) 0%,
        rgba(20, 28, 46, 0) 55%)
      ,
      linear-gradient(180deg, #0a0f14 0%, #0a0d13 45%, #07090d 100%);

    --actBtn:    44px;
    --actIcon:   24px;
    --actStroke: 2.25px;
    --actColor:    #bcc3cc;
    --actColorHi:  #e6e9ee;

    --surface-glass: rgba(18, 22, 28, .55);
    --surface-opaque: #0f141b;
    --cell-bg: #10161e;

    --gridBorder: rgba(255,255,255,.08);
    --border-soft: rgba(255,255,255,.06);

    --text:#f2f4f7;
    --muted:#a6b0bb;

    --blue-rgb: 56,124,255;
    --today: rgba(56,124,255,.18);
    --sunday:#e04d4d;

    --actHover:  rgba(255,255,255,.08);
    --actActive: rgba(255,255,255,.14);

    --tabColor:#b7bcc6;
    --tabColorActive:#eef2f7;
    --tabHoverBg: rgba(255,255,255,.08);
    --tabActiveBg: rgba(255,255,255,.14);
  }
  body{ background: var(--bg) fixed !important; color: var(--text); }
  .topbar, .tabbar{
    background: var(--surface-glass) !important;
    backdrop-filter: blur(14px) saturate(160%);
    -webkit-backdrop-filter: blur(14px) saturate(160%);
    border: 1px solid var(--border-soft);
    box-shadow: 0 8px 26px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
  }
  .settingsCard{
    background: var(--surface-opaque) !important;
    border: 1px solid var(--gridBorder) !important;
    box-shadow: 0 10px 28px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
  }
  .cell{
    background: var(--cell-bg) !important;
    border: 1px solid var(--border-soft) !important;
    box-shadow: 0 1px 0 rgba(255,255,255,.02) inset;
  }
  .cell::before{ transition: background .18s ease, box-shadow .18s ease; }
  .cell:hover::before{ box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }

/* Giorno di oggi: effetto hover potenziato (versione soft) */
.today::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  background: color-mix(in oklch, var(--actHover) 55%, white 25%);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.15),
    0 0 12px 4px rgba(var(--blue-rgb),.20),
    0 0 20px 8px rgba(var(--blue-rgb),.10);
  pointer-events: none;
}
  
  .weekhead div{
    background: rgba(56,124,255,.22) !important; border: 1px solid rgba(56,124,255,.34) !important;
    color: #fff; text-align:center; padding:8px 0; font-weight:700; border-radius:10px; letter-spacing:.03em; font-size:.82rem;
  }
  .cell:not(.sun) .num{ color: rgba(240,244,248,.86); }
  .topbar{ box-shadow: inset 0 -1px 0 rgba(255,255,255,.04), inset 0  1px 0 rgba(0,0,0,.55); }
  .brandmark svg path{ filter: drop-shadow(0 1px 0 rgba(255,255,255,.07)) drop-shadow(0 10px 24px rgba(56,124,255,.20)); }
  .settingsRow input, .settingsRow select, .orarioArea{
    background: #0e141b !important; border: 1px solid var(--gridBorder) !important; color: var(--text) !important;
  }
  .dither{ display:none !important; }
  </style>
</head>
<!-- ======================= -->
<!-- fine head             -->
<!-- ======================= -->
<!-- ======================= -->
<!-- inizio body            -->
<!-- ======================= -->
<body>
  <div class="dither" aria-hidden="true"></div>

     <!-- =======================================================
     [HTML-TOPBAR] Logo + scritta POLIZIA + omino a destra
     ======================================================= -->
<div class="topbar" aria-label="Intestazione Polizia">
  <div class="brandmark" aria-label="Polizia" role="img">
    <!-- SVG POLIZIA  -->
    <svg viewBox="0 0 2048 426" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path transform="translate(602,146)" d="m0 0h157l10 4 7 7 3 8v14l-9 45-6 25-4 10-7 9-10 7-8 3-6 1-33 1h-118l-13-4-6-4-4-5-3-10 1-15 12-56 4-13 5-10 10-10 10-5zm54 22-9 2-4 4-4 15-11 52-1 9 3 5 6 2h42l7-2 5-6 7-28 7-37 1-11-3-4-4-1z" fill="#FEFEFE"/>
    <path transform="translate(1634,144)" d="m0 0h105l10 2 5 5 2 7 5 97v17l-3 5-3 2h-63l-4-5-2-27-2-4h-54l-6 3-5 8-8 17-6 7-3 1h-61l-4-3 1-9 12-25 17-35 12-25 7-12 9-10 7-6 14-7 9-2zm35 24-9 3-4 5-13 26-4 10 2 5 3 1h35l5-3v-17l-2-25-3-4-3-1z" fill="#FEFEFE"/>
    <path transform="translate(419,144)" d="m0 0h65l21 3 9 4 5 4 3 6 1 5v15l-3 18-6 17-6 10-5 6-10 6-8 3-6 1-103 1-7 3-4 8-4 15-4 6-5 4-3 1-22 1h-15l-19-1-5-3-1-2v-10l14-67 6-24 5-10 8-9 10-6 11-3 9-1zm-27 25-7 2-3 3-4 12-5 24 1 5 4 3h56l5-3 3-5 6-27v-11l-4-3z" fill="#FEFEFE"/>
    <path transform="translate(1276,144)" d="m0 0h68l47 1 3 3-1 6-8 8-11 9-13 11-10 8-13 11-10 8-14 12-10 8-21 18h-2l-2 4 1 4 5 1 85 1 5 5v8l-6 7-9 3h-174l-5-2-1-1v-6l4-5 11-9 13-11 10-8 13-11 11-9 13-11 11-9 13-11 11-9 4-5v-3l-8-1-82-1-5-3-2-3v-6l4-6 8-4 7-1z" fill="#FEFEFE"/>
    <path transform="translate(859,146)" d="m0 0h38l4 2 2 4v8l-12 58-5 24v9l5 4 6 1 110 1 5 3 1 1v9l-6 7-9 3h-161l-12-3-8-5-4-5-3-7v-15l14-66 5-12 7-9 9-7 9-4z" fill="#FEFEFE"/>
    <path transform="translate(1451,146)" d="m0 0h62l5 4v12l-22 104-4 11-4 2h-60l-5-3-2-8 9-44 14-65 3-9z" fill="#FEFEFE"/>
    <path transform="translate(1088,146)" d="m0 0h61l6 5v9l-15 71-9 40-3 6-4 2h-61l-5-5v-8l15-72 9-41 4-6z" fill="#FEFEFE"/>
    <path transform="translate(1757,146)" d="m0 0 3 3 2 6 2 30 3 62 1 24-3 8-6 5-2 1h-66l-5-3-3-3-2-9v-21l-52 1-10 19-6 10-6 5-3 1h-65l-6-4-3-6 1-8 11-23 1 3-9 19-1 4v7l4 4 6 2h60l6-3 6-8 9-19 4-5 2-1h51l1 1 2 26 3 6 6 3h62l6-3 4-7v-16l-4-81-2-23z" fill="#FEFEFE"/>
    <path transform="translate(1453,139)" d="m0 0h59l7 3 5 6 1 2v10l-12 57-11 52-4 10-5 5-3 1h-64l-8-5-3-6v-10l18-85 6-26 4-8 1 2-4 12-20 94-2 9v13l2 5 10 3h58l5-2 4-5 3-9 17-81 5-23v-14l-5-6-8-2h-53l-10 2 3-3z" fill="#FEFEFE"/>
    <path transform="translate(1224,138)" d="m0 0h159l10 1 6 5 2 4-1 6-4 6-7 7-2-1 8-8 3-6-1-7-5-4h-178l-12 3-5 4-3 5-1 9 3 6 5 3 6 1 79 1-2 4-5 5-2-1 5-5-1-1-79-1-6-3-4-5-1-2v-10l5-8 7-5 8-2z" fill="#FEFEFE"/>
    <path transform="translate(655,173)" d="m0 0h44l1 5-5 28-9 40-4 5-16 1-33-1-1-4 13-62 3-9 2-2zm4 2-8 1-3 5-13 62v6l41 1 6-1 5-16 10-50 1-7-6-1z" fill="#FEFEFE"/>
    <path transform="translate(835,150)" d="m0 0 2 1-8 8-7 14-7 29-9 44v14l4 10 4 5 8 5 9 3 6 1 18 1h130l18-2 8-4 5-6 1-2v-10l-3-5-3-3 5 2 3 4 1 3v7l-4 8-7 6-8 3-6 1h-153l-13-2-12-5-7-6-5-9-2-6v-11l10-49 6-25 4-9 6-9z" fill="#FEFEFE"/>
    <path transform="translate(365,138)" d="m0 0h123l19 3 10 4 7 6 4 8 1 4v23l-3 15-5 15-7 13-10 10-2-1 10-10 8-16 5-17 2-18-1-16-5-10-9-6-11-3-7-1-31-1h-28l-86 1-17 3-3-1 10-3 5-1z" fill="#FEFEFE"/>
    <path transform="translate(1291,245)" d="m0 0 2 1-2 3 76 1 7 2 6 5 2 4v10l-4 6-7 6-8 3-6 1h-169l-9-3-5-4-1-8 3-6 4-5 2 1-5 6-1 3v7l4 4 6 2 9 1h153l13-1 9-3 7-6 2-4v-10l-4-6-4-2-8-1-77-1v-2z" fill="#FEFEFE"/>
    <path transform="translate(1089,139)" d="m0 0h59l7 3 1 2-11-3h-53l-9 3-4 6-6 26-18 85-1 13 2 5 5 3 4 1h59l7-2-2 3-3 1h-64l-7-4-3-5v-13l12-58 11-51 4-9 4-4z" fill="#FEFEFE"/>
    <path transform="translate(394,174)" d="m0 0h49l1 3-6 29-3 6-1 1h-55l-1-3 7-31 3-4zm-1 2-5 2-4 15-3 13v5h52l3-7 5-22v-6z" fill="#FEFEFE"/>
    <path transform="translate(862,139)" d="m0 0h33l8 3 6 7 1 9-10 48-9 43 113 1 7 2-3 1-10-1-106-1-2-1v-8l17-81v-10l-3-5-6-4-6-1h-26l-16 3-8 4-2-1 12-6z" fill="#FEFEFE"/>
    <path transform="translate(315,151)" d="m0 0 2 1-8 9-6 12-9 39-11 54v9l3 5 4 3 14 2h34l12-1 8-4 5-6 4-11 3-12 2-1-2 11-3 10-5 8-6 5-10 3h-50l-9-3-5-5-2-5 1-12 14-67 5-20 5-12 8-10z" fill="#FEFEFE"/>
    <path transform="translate(554,274)" d="m0 0 16 8 8 2 9 1h41l72-1 29-1 10-2 9-3-3 3-12 4-21 1-46 1h-86l-15-4-10-6z" fill="#FEFEFE"/>
    <path transform="translate(1644,137)" d="m0 0h82l18 1 9 3 4 3-1 2-6-4-12-2h-106l-16 3-12 5-4 1 3-3 12-5 13-3z" fill="#FEFEFE"/>
    <path transform="translate(1669,173)" d="m0 0h7l1 1 2 23v16h-34l1-5 12-26 5-7zm1 2-7 3-8 16-7 15v2h29v-10l-2-25z" fill="#FEFEFE"/>
    <path transform="translate(605,139)" d="m0 0h151l9 2 4 3-9-2-8-1h-143l-16 3-16 8 5-5 10-5z" fill="#FEFEFE"/>
    <path transform="translate(1157,145)" d="m0 0 4 4 1 6-3 18-20 93-4 12-3 2 2-6 4-15 17-80 4-19v-9z" fill="#FEFEFE"/>
    <path transform="translate(573,155)" d="m0 0v3l-6 9-5 15-10 46-3 15v18l4 10v3l-4-5-3-10v-13l6-31 7-31 5-16 7-11z" fill="#FEFEFE"/>
    <path transform="translate(777,150)" d="m0 0 5 5 3 7 1 5v9l-8 42-8 33-4 10-6 8-2 1 2-4 6-10 5-19 8-37 4-21v-14l-4-11z" fill="#FEFEFE"/>
    <path transform="translate(490,244)" d="m0 0 3 1-10 3-9 1h-101l4-2h55l48-1z" fill="#FEFEFE"/>
    <path transform="translate(1588,158)" d="m0 0v3l-7 9-12 23-19 39-6 12-1-3 14-28 11-23 12-23z" fill="#FEFEFE"/>
    <path transform="translate(1350,196)" d="m0 0 2 1-10 9-14 11-9 8-6 5-2-1 10-9 11-9 13-11z" fill="#FEFEFE"/>
    <path transform="translate(1309,230)" d="m0 0 2 1-10 9-6 5-2-1 11-10z" fill="#FEFEFE"/>
    <path transform="translate(1373,177)" d="m0 0 2 1-10 9-5 4-2-1 10-9z" fill="#FEFEFE"/>
    <path transform="translate(1233,217)" d="m0 0 2 1-10 9-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1385,167)" d="m0 0 2 1-10 9-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1598,149)" d="m0 0 2 1-7 6-2-1z" fill="#FEFEFE"/>
    <path transform="translate(756,270)" d="m0 0 2 1-5 5-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1186,256)" d="m0 0 2 1-4 4-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1192,251)" d="m0 0 2 1-4 4-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1198,246)" d="m0 0 2 1-4 4-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1209,237)" d="m0 0 2 1-4 4-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1215,232)" d="m0 0 2 1-4 4-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1221,227)" d="m0 0 2 1-4 4-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1244,208)" d="m0 0 2 1-4 4-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1256,198)" d="m0 0 2 1-4 4-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1262,193)" d="m0 0 2 1-4 4-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1356,191)" d="m0 0 2 1-4 4-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1268,188)" d="m0 0 2 1-4 4-2-1z" fill="#FEFEFE"/>
    <path transform="translate(321,147)" d="m0 0 2 1-4 3-2-1z" fill="#FEFEFE"/>
    <path transform="translate(769,144)" d="m0 0 5 2 1 2-5-2z" fill="#FEFEFE"/>
    <path transform="translate(1203,242)" d="m0 0 2 1-3 3-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1238,213)" d="m0 0 2 1-3 3-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1250,203)" d="m0 0 2 1-3 3-2-1z" fill="#FEFEFE"/>
    <path transform="translate(1274,183)" d="m0 0 2 1-3 3-2-1z" fill="#FEFEFE"/>
    <path transform="translate(326,144)" d="m0 0 3 1-6 2z" fill="#FEFEFE"/>
    <path transform="translate(749,276)" d="m0 0 2 1h-3z" fill="#FEFEFE"/>
    <path transform="translate(500,239)" d="m0 0 2 1h-3z" fill="#FEFEFE"/>
    <path transform="translate(838,148)" d="m0 0 2 1h-3z" fill="#FEFEFE"/>
    <path transform="translate(1444,143)" d="m0 0 2 1-2 1z" fill="#FEFEFE"/>
    <path transform="translate(493,243)" d="m0 0 2 1z" fill="#FEFEFE"/>
    <path transform="translate(495,242)" d="m0 0 2 1z" fill="#FEFEFE"/>
    <path transform="translate(497,241)" d="m0 0 2 1z" fill="#FEFEFE"/>
    <path transform="translate(1131,280)" d="m0 0" fill="#FEFEFE"/>
    <path transform="translate(372,249)" d="m0 0" fill="#FEFEFE"/>
    <path transform="translate(1246,207)" d="m0 0" fill="#FEFEFE"/>
    <path transform="translate(1270,187)" d="m0 0" fill="#FEFEFE"/>
    <path transform="translate(1276,182)" d="m0 0" fill="#FEFEFE"/>
    <path transform="translate(1589,157)" d="m0 0" fill="#FEFEFE"/>
    <path transform="translate(1590,156)" d="m0 0" fill="#FEFEFE"/>
    <path transform="translate(574,154)" d="m0 0" fill="#FEFEFE"/>
    <path transform="translate(575,153)" d="m0 0" fill="#FEFEFE"/>
    <path transform="translate(576,152)" d="m0 0" fill="#FEFEFE"/>
    <path transform="translate(776,149)" d="m0 0" fill="#FEFEFE"/>
    <path transform="translate(775,148)" d="m0 0" fill="#FEFEFE"/>
    <path transform="translate(1156,144)" d="m0 0" fill="#FEFEFE"/>
  </svg>
  </div>

<!-- SLOT DESTRO CON OMINO + MENU -->
<div class="topbar-right">
  <button id="acctBtnHeader"
          class="dropboxIconBtn dbx-off"
          title="Account"
          aria-label="Account"
          aria-haspopup="menu"
          aria-controls="acctMenu"
          aria-expanded="false"
          type="button"></button>

  <!-- Menu a tendina (sibling del bottone, NON dentro) -->
<div id="acctMenu" class="acct-menu" role="menu" aria-hidden="true"
     style="position:fixed;display:none;left:-9999px;top:-9999px;z-index:9999;">

  <!-- Head del menu: titolo + stato -->
  <div class="acct-head" role="presentation" aria-hidden="false">
    <div class="acct-head-title">Personale</div>
    <div id="acctHeadStatus" class="acct-head-status">Sincronizzazione attiva</div>
  </div>

  <div class="acct-sep"></div>

  <!-- Azioni -->
<button type="button" class="acct-item" data-act="login">Connetti con Google</button>
<button type="button" class="acct-item" data-act="save">Salva su Google</button>
<button type="button" class="acct-item" data-act="sync">Sincronizza adesso</button>
<button type="button" class="acct-item" data-act="import-bak">Importa backup</button>
<div class="acct-sep"></div>
<button type="button" class="acct-item danger" data-act="logout">Disconnetti</button>
</div>

  
</div>

</div>

  <!-- =======================================================
       [HTML-CALENDAR VIEW] Vista calendario
       ======================================================= -->
  <main>
    <section class="view active" id="view-calendar">
      <div class="monthbar">
        <button class="navbtn" id="prev">&#x276E;</button>
        <div class="title" id="monthLabel">ottobre 2025</div>
        <button class="navbtn" id="next">&#x276F;</button>
      </div>
      <div class="weekhead"><div>LUN</div><div>MAR</div><div>MER</div><div>GIO</div><div>VEN</div><div>SAB</div><div>DOM</div></div>
      <section class="grid" role="grid" aria-labelledby="monthLabel"></section>
    </section>

    <!-- =====================================================
         [HTML-SETTINGS VIEW] Vista impostazioni
         ===================================================== -->
    <section class="view" id="view-settings">
      <div class="settingsCard" id="set-turni">
        <!-- [SET-REF SHIFT] Primo giorno -->
        <div class="settingsRow" style="grid-template-columns:120px 1fr">
          <label>Primo giorno</label>
          <input type="date" id="startDate" />
        </div>

        <!-- =========================================================
             [UI-ACTIONS] Salva su Google + Importa da Google (icone)
             ========================================================= -->
        <div class="settingsRow" style="grid-template-columns:1fr; align-items:center; margin-top:6px">
          <div class="actionIcons">
            <!-- Salva su Google -->
            <button id="btnSaveCloud" class="btn-icon" aria-label="Salva su Google" title="Salva su Google">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M7.5 3h9a2 2 0 0 1 2 2v14a1 1 0 0 1-1 1h-13a1 1 0 0 1-1-1V5a2 2 0 0 1 2-2Z" />
                <path d="M8 12h8M12 8v8" />
              </svg>
            </button>

            <!-- Importa da Google -->
            <button id="btnImportCloud" class="btn-icon" aria-label="Importa da Google" title="Importa da Google">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M7.5 3h9a2 2 0 0 1 2 2v14a1 1 0 0 1-1 1h-13a1 1 0 0 1-1-1V5a2 2 0 0 1 2-2Z" />
                <path d="M12 16V8M12 8l-3 3M12 8l3 3" />
              </svg>
            </button>
          </div>
        </div>

        <!-- =========================================================
             [UI-ACCOUNT ICON SETTINGS] Icona + stato + Disconnetti
             ========================================================= -->
        <div class="settingsRow" style="grid-template-columns:1fr;align-items:center">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            <button id="acctBtnSettings" class="dropboxIconBtn dbx-off" title="Accedi con Google" aria-label="Accedi con Google">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5Z" fill="currentColor"/>
              </svg>
            </button>

            <span id="cloudStatusSettings" class="todayDate"></span>

            <!-- Pulsante disconnessione: visibile solo quando connessi -->
            <button id="acctDisconnect" type="button" class="textbtn textbtn-danger" style="display:none">
              Disconnetti
            </button>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--gridBorder);margin:12px 0" />

        <!-- [SET-HEAD] Intestazioni turni -->
        <div class="settingsRow turni-grid turni-head">
          <div style="font-weight:700;color:var(--muted)">Turno</div>
          <div style="font-weight:700;color:var(--muted)">Sigla</div>
          <div style="font-weight:700;color:var(--muted)">Orario</div>
          <div style="font-weight:700;color:var(--muted)">Colore</div>
          <div></div>
        </div>
        <div class="thin-sep"></div>

        <!-- [SET-ADD ROW] Riga “Aggiungi turno” -->
        <div class="settingsRow turni-grid" style="align-items:center">
          <div><input id="newNome"></div>
          <div><input id="newSigla" class="siglaInput" maxlength="4"></div>
          <textarea id="newOrario" class="orarioArea" rows="2" placeholder="00:00&#10;00:00"></textarea>
          <div class="colorCell"><input id="newColor" class="colorInput" type="color" value="#8e88ff" title="Colore"></div>
          <button id="btnAddTurno" type="button" class="iconbtn iconbtn-primary" title="Aggiungi">+</button>
        </div>

        <!-- [SET-LIST] Elenco turni -->
        <div id="turniList"></div>
      </div>
    </section>

    <!-- =========================================================
         [UI-ACCOUNT MODAL] Popup collegamento Google (simulato)
         ========================================================= -->
    <div id="acctModal" class="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="acctModalTitle">
      <div class="modalCard">
        <div class="modalHeader">
          <div class="modalTitle" id="acctModalTitle">Accedi con Google</div>
          <button id="acctModalClose" class="iconbtn iconbtn-danger" title="Chiudi">✕</button>
        </div>
        <div class="modalBody">
          Verrà avviata la procedura di accesso a Google. In questa build è una simulazione: vedrai l’icona cambiare e potrai salvare/importare dati di prova. Inseriremo più avanti il tuo <em>Client ID</em> per attivare Drive AppData reale.
        </div>
        <div class="modalActions">
          <button id="acctModalGo" class="savebtn">Procedi</button>
        </div>
      </div>
    </div>
  </main>
  <!-- =======================================================
       [HTML-TABBAR] Navigazione inferiore
       ======================================================= -->
  <nav class="tabbar" aria-label="Barra schede">
    <div class="tab active" data-tab="calendar" aria-label="Calendario">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
           fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    </div>

    <div class="tab" data-tab="settings" aria-label="Impostazioni">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
           fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33
                 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51
                 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06
                 a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09
                 a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06
                 a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09
                 a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09
                 a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06
                 a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09
                 a1.65 1.65 0 0 0-1.51 1z"/>
      </svg>
    </div>
  </nav>

  <!-- =======================================================
       [JS-MAIN] Script principale pagina Turni PDS
       ======================================================= -->
  <script>
  "use strict";

  // ======================= //
  // inizio JSS (script)     //
  // ======================= //

  // =========================================================
  // [FN: util_jsWeekdayUTC] Lunedì=0 … Domenica=6 (UTC)
  // =========================================================
  function util_jsWeekdayUTC(d){ return (d.getUTCDay()+6)%7 }

  // =========================================================
  // [FN: util_pad2] Padding numeri a 2 cifre
  // =========================================================
  function util_pad2(n){ return n.toString().padStart(2,'0') }

  // =========================================================
  // [FN: util_fmtMonth] “ottobre 2025”
  // =========================================================
  function util_fmtMonth(fmt,y,m){ return fmt.format(new Date(y,m,1)) }

  // =========================================================
  // [FN: util_splitOrario / util_joinOrarioMultiline]
  // =========================================================
  function util_splitOrario(s){
    const parts = String(s||'').split(/[-–—]/).map(x=>x.trim());
    return { start: parts[0]||'', end: parts[1]||'' };
  }
  function util_joinOrarioMultiline(txt){
    const [rawS='', rawE=''] = String(txt||'').split(/\n/);
    const s = (rawS || '').trim();
    const e = (rawE || '').trim();
    return (s || e) ? `${s}–${e}` : '';
  }

  // =======================================================
  // [STORAGE PAYLOAD] JSON che salveremo (mock AppData)
  // =======================================================
  function storage_buildPayload(){
    return {
      _meta:{
        app:"Turni Polizia di Stato",
        version:1,
        savedAt:new Date().toISOString()
      },
      settings: settings_effective(),     // {date, shift}
      defs:     defs_effective()          // lista turni personalizzati
    };
  }
  function storage_buildFilename(){
    const now = new Date();
    const y = now.getFullYear();
    const m = util_pad2(now.getMonth()+1);
    return `${y}-${m}-TURNI.json`;
  }

  // =========================================================
  // [BLOCK: JS-STATE]
  // =========================================================
  const itMonth = new Intl.DateTimeFormat('it-IT',{month:'long',year:'numeric'});
  const today   = new Date();
  let   view    = new Date(Date.UTC(today.getFullYear(), today.getMonth(), 1));

  const grid        = document.querySelector('.grid');
  const monthLabel  = document.getElementById('monthLabel');
  const todayHeader = document.getElementById('todayHeader');

  // =========================================================
  // [BLOCK: STORAGE KEYS] LocalStorage + default turni
  // =========================================================
  const LS_KEY   = 'cal_turno_start_v1';
  const LS_TURNS = 'cal_turni_defs_v2';

  const SHIFT_DEFAULTS = [
    { key:'S', nome:'Sera',       sigla:'S', orario:'18:55–00:08', color:'#8e88ff' },
    { key:'P', nome:'Pomeriggio', sigla:'P', orario:'12:55–19:08', color:'#c7a47b' },
    { key:'M', nome:'Mattina',    sigla:'M', orario:'06:55–13:08', color:'#f1a04f' },
    { key:'N', nome:'Notte',      sigla:'N', orario:'23:55–07:08', color:'#9aa3ad' },
    { key:'R', nome:'Riposo',     sigla:'R', orario:'—',           color:'#28a745' }
  ];

  // =========================================================
  // [FN: defs_*] Gestione definizioni turni personalizzate
  // =========================================================
  function defs_load(){ try{ return JSON.parse(localStorage.getItem(LS_TURNS))||null }catch{ return null } }
  
function defs_save(list){
  // salva SOLO quello che gli passi, senza altre magie
  localStorage.setItem(LS_TURNS, JSON.stringify(list));
  // niente autosave qui, perché ora lo vogliamo solo manuale
}

function defs_effective(){
  // leggiamo quello che c'è
  const l = defs_load();

  // se c’è roba valida, la restituiamo e BASTA
  if (Array.isArray(l) && l.length) {
    return l;
  }

  // se non c’è niente, usiamo i default
  // e in questo caso SOLTANTO li salviamo
  const out = SHIFT_DEFAULTS.map(item => ({
    key:   item.key || item.sigla || 'S',
    nome:  item.nome || '',
    sigla: item.sigla || '',
    orario:item.orario || '',
    color: item.color || '#8e88ff'
  }));

  defs_save(out);
  return out;
}


  // =========================================================
  // [FN: settings_*] Primo giorno (data+base)
  // =========================================================
  function settings_load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||null }catch{ return null } }
  function settings_save(obj){
  localStorage.setItem(LS_KEY, JSON.stringify(obj));
  // segna modifiche e tenta autosalvataggio (coalescenza interna)
  autosave_schedule(400);
}

  function settings_effective(){
    const s=settings_load();
    if(s && s.date && s.shift) return s;
    const t=new Date();
    const def={date:`${t.getFullYear()}-${util_pad2(t.getMonth()+1)}-${util_pad2(t.getDate())}`, shift:'S'};
    settings_save(def); return def;
  }

  // =========================================================
  // [FN: shifts_codeForDate] ciclo S→P→M→N→R con GL/AP
  // =========================================================
  const BASE_SEQ=['S','P','M','N','R'];
  function shifts_codeForDate(d){
    const cfg=settings_effective();
    const [y,m,dd]=cfg.date.split('-').map(Number);
    const anchor=new Date(Date.UTC(y,m-1,dd));
    const idx0=BASE_SEQ.indexOf(cfg.shift);
    const daysDiff=Math.floor((Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate())-Date.UTC(anchor.getUTCFullYear(),anchor.getUTCMonth(),anchor.getUTCDate()))/86400000);
    const step=((idx0+(daysDiff%5)+5)%5);
    const raw=BASE_SEQ[step];
    if(raw!=='R') return raw;
    const dow=util_jsWeekdayUTC(d);
    if(dow===0) return 'GL';
    if(dow===1) return 'AP';
    return 'R';
  }

  // =========================================================
  // [FN: ui_displayLabelFor / ui_colorForBase]
  // =========================================================
  function ui_displayLabelFor(base){
    const f = defs_effective().find(x => x.key === base);
    return f && f.sigla ? f.sigla : base;
  }
  function ui_colorForBase(base){
    const f = defs_effective().find(x => x.key === base);
    return (f && f.color) ? f.color : '#8e88ff';
  }

  // =========================================================
  // [FN: render_*] Celle + intero mese
  // =========================================================
  function render_createCellHTML({day, sun, sigla, isToday, startCol}){
    const classes = ['cell']; if (sun) classes.push('sun'); if (isToday) classes.push('today');
    const startAttr = startCol ? ` style="grid-column-start:${startCol}"` : '';

    const isGLAP = (sigla === 'GL' || sigla === 'AP');
    const label  = isGLAP ? sigla : ui_displayLabelFor(sigla);
    const color  = isGLAP ? null  : ui_colorForBase(sigla);

    let siglaSpan = '';
    if (label) {
      siglaSpan = isGLAP
        ? `<span class="sigla ${sigla==='GL'?'T-GL':'T-AP'}">${label}</span>`
        : `<span class="sigla" style="color:${color}">${label}</span>`;
    }
    return `<div class="${classes.join(' ')}"${startAttr}><span class="num">${util_pad2(day)}</span>${siglaSpan}</div>`;
  }

  function render_buildMonth(year,month){
    grid.innerHTML='';
    const first=new Date(Date.UTC(year,month,1));
    const last =new Date(Date.UTC(year,month+1,0));
    const lead =util_jsWeekdayUTC(first);
    monthLabel.textContent=util_fmtMonth(itMonth,year,month);

    for(let day=1; day<=last.getUTCDate(); day++){
      const d=new Date(Date.UTC(year,month,day));
      const isSun = util_jsWeekdayUTC(d)===6;
      const isT   = d.getUTCFullYear()===today.getFullYear() && d.getUTCMonth()===today.getMonth() && d.getUTCDate()===today.getDate();
      const sigla = shifts_codeForDate(d);
      const startCol = (day===1)? (lead+1) : undefined;
      grid.insertAdjacentHTML('beforeend', render_createCellHTML({day,sun:isSun,sigla,isToday:isT,startCol}));
    }
  }

  // =========================================================
  // [FN: nav_shift] prev/next mese
  // =========================================================
  function nav_shift(delta){
    view=new Date(Date.UTC(view.getUTCFullYear(), view.getUTCMonth()+delta, 1));
    render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());
  }

  // =========================================================
  // [FN: ui_switchTab] calendario <-> impostazioni
  // =========================================================
  function ui_switchTab(name){
    const isSettings = (name === 'settings');

    document.body.classList.toggle('hide-topbar', isSettings);
    document.body.classList.toggle('no-scroll', !isSettings);

    document.querySelectorAll('.tab').forEach(el =>
      el.classList.toggle('active', el.dataset.tab === name)
    );
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(`view-${name}`).classList.add('active');

    ui_updateTopbarGlowCenter();
  }

  // =========================================================
  // [FN: ui_defsRenderList] lista turni
  // =========================================================
  function ui_defsRenderList(){
    const list=defs_effective();
    const wrap=document.getElementById('turniList');
    wrap.innerHTML='';
    list.forEach((t,idx)=>{
      const row=document.createElement('div');
      row.className='settingsRow turni-grid';
      row.style.alignItems='center';

      const p = util_splitOrario(t.orario);
      row.innerHTML = [
        `<input value="${t.nome}" data-k="nome" data-i="${idx}" />`,
        `<input value="${t.sigla}" maxlength="4" class="siglaInput" data-k="sigla" data-i="${idx}" />`,
        `<textarea class="orarioArea" data-k="orarioMultiline" data-i="${idx}" rows="2">${p.start}\n${p.end}</textarea>`,
        `<div class="colorCell"><input value="${t.color || '#8e88ff'}" class="colorInput" data-k="color" data-i="${idx}" type="color" /></div>`,
        `<button type="button" class="iconbtn iconbtn-danger" data-act="del" data-i="${idx}">✕</button>`
      ].join('');

      wrap.appendChild(row);
    });

    wrap.querySelectorAll('button[data-act="del"]').forEach(b=>{
      b.addEventListener('click', ()=> ui_defsDelete(parseInt(b.dataset.i)));
    });

    wrap.querySelectorAll('input, textarea').forEach(inp=>{
      const h = ()=>{
        ui_defsEditInline(parseInt(inp.dataset.i), inp.dataset.k, inp.value);
        render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());
      };
      inp.addEventListener('input', h);
      inp.addEventListener('change', h);
    });
  }

  // =========================================================
  // [FN: CRUD turni]
  // =========================================================
  function ui_defsAdd(){
  const nome  = document.getElementById('newNome').value.trim();
  const sigla = document.getElementById('newSigla').value.trim().toUpperCase();
  const orTxt = document.getElementById('newOrario').value;
  const color = document.getElementById('newColor').value.trim() || '#8e88ff';
  if(!nome || !sigla) return;
  const orario = util_joinOrarioMultiline(orTxt);
  const list=defs_effective();
  list.push({ key:'X'+Date.now(), nome, sigla, orario, color });
  defs_save(list);
  ui_defsClearNew();
  ui_defsRenderList();
  render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());
  autosave_schedule();
}
  function ui_defsClearNew(){
    document.getElementById('newNome').value = '';
    document.getElementById('newSigla').value = '';
    document.getElementById('newOrario').value = '';
    document.getElementById('newColor').value = '#8e88ff';
  }
  function ui_defsDelete(i){
  const list=defs_effective();
  list.splice(i,1);
  defs_save(list);
  ui_defsRenderList();
  render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());
  autosave_schedule();
}

  function ui_defsEditInline(i,key,val){
  const list=defs_effective();
  if(!list[i]) return;
  if(key==='orarioMultiline'){
    list[i].orario = util_joinOrarioMultiline(val);
  }else{
    list[i][key]=val;
  }
  defs_save(list);
  render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());
  autosave_schedule();
}


  // =========================================================
  // [FN: ui_settings*]
  // =========================================================
  function ui_settingsInit(){
    const c=settings_effective();
    document.getElementById('startDate').value=c.date;
    ui_defsRenderList();
  }
  function ui_settingsApply(){
  __hasUnsavedChanges = true;
  const date=document.getElementById('startDate').value;
  const shift=settings_effective().shift || 'S';
  settings_save({date,shift});
  render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());
  autosave_schedule();
}


  // =========================================================
  // [FN: ui_updateTopbarGlowCenter] allinea glow
  // =========================================================
  function ui_updateTopbarGlowCenter(){
    const bar = document.querySelector('.topbar');
    if(!bar) return;
    const r = bar.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top  + r.height/2;
    document.documentElement.style.setProperty('--cx', cx + 'px');
    document.documentElement.style.setProperty('--cy', cy + 'px');
    document.documentElement.style.setProperty('--bar-h', r.height + 'px');
  }
// =========================================================
// [GOOGLE AUTH v2 - GIS popup + access_token]
// =========================================================

// client web (quello che avevi già)
const GOOGLE_CLIENT_ID = "280688458605-2l6l10drhsrhfct6540divn87h769aif.apps.googleusercontent.com";

// scope che ci servono
const GOOGLE_SCOPES = [
  "openid",
  "email",
  "profile",
  "https://www.googleapis.com/auth/drive.appdata"
].join(" ");

// storage keys (stessi nomi di prima, così il resto del codice non cambia)
const LS_GOOGLE_TOKEN       = "google_access_token";
const LS_GOOGLE_EXPIRES_AT  = "google_access_expires_at";
const LS_GOOGLE_IDTOKEN     = "google_id_token";
const LS_GOOGLE_EMAIL       = "google_user_email";
const LS_GOOGLE_PHOTO       = "google_user_photo";
const LS_GOOGLE_REFRESH     = "google_refresh_token";

let __gisLoaded   = false;
let __gisLoading  = false;
let __gisTokenCli = null;

// carica lo script ufficiale Google Identity Services
function g_loadGisScript() {
  return new Promise((resolve, reject) => {
    if (__gisLoaded) {
      resolve();
      return;
    }
    if (__gisLoading) {
      // se sta già caricando, aspetta che finisca
      const iv = setInterval(() => {
        if (__gisLoaded) {
          clearInterval(iv);
          resolve();
        }
      }, 80);
      return;
    }
    __gisLoading = true;
    const s = document.createElement("script");
    s.src = "https://accounts.google.com/gsi/client";
    s.async = true;
    s.defer = true;
    s.onload = () => {
      __gisLoaded = true;
      __gisLoading = false;
      resolve();
    };
    s.onerror = () => {
      __gisLoading = false;
      reject(new Error("Impossibile caricare Google Identity Services."));
    };
    document.head.appendChild(s);
  });
}

// token valido?
// Sei connesso SOLO se:
// - hai un access token
// - NON è scaduto
// - hai anche l'email dell'utente
// Connesso se e solo se esiste un access token NON scaduto.
// L'email NON è più requisito (verrà recuperata in background se manca).
function g_isConnected(){
  const tok = localStorage.getItem(LS_GOOGLE_TOKEN);
  const exp = parseInt(localStorage.getItem(LS_GOOGLE_EXPIRES_AT) || "0", 10);
  if (!tok) return false;
  if (Date.now() >= (exp - 10_000)) return false;
  return true;
}


// UI: aggiorna le icone (testa se connesso e mostra avatar/badge)
// UI: aggiorna le icone. Se il token risulta scaduto prova un refresh UNA volta.
// Se siamo connessi ma manca la foto, prova a leggerla (silenziosamente) e poi ridisegna.
async function g_updateIcons() {
  const mail = localStorage.getItem(LS_GOOGLE_EMAIL) || localStorage.getItem("google_user_email") || "";

  // Determina lo stato tentando un refresh se serve
  let on = false;
  try {
    await g_ensureValidAccess(); // se serve, rinfresca
    const tok = localStorage.getItem(LS_GOOGLE_TOKEN);
    const exp = parseInt(localStorage.getItem(LS_GOOGLE_EXPIRES_AT) || "0", 10);
    on = !!(tok && Date.now() < (exp - 10_000));
  } catch {
    on = false;
  }

  // Se connesso ma senza foto, prova a recuperare userinfo UNA volta
  let photo = on ? (localStorage.getItem(LS_GOOGLE_PHOTO) || "") : "";
  if (on && !photo) {
    try {
      await g_fetchUserInfo(); // aggiorna LS_GOOGLE_PHOTO se disponibile
      photo = localStorage.getItem(LS_GOOGLE_PHOTO) || "";
    } catch {}
  }

  const h   = document.getElementById("acctBtnHeader");
  const s   = document.getElementById("acctBtnSettings");
  const st2 = document.getElementById("cloudStatusSettings");
  const dis = document.getElementById("acctDisconnect");

  [h, s].forEach(el => {
    if (!el) return;
    el.classList.toggle("dbx-on",  on);
    el.classList.toggle("dbx-off", !on);

    const inner = (on && photo)
      ? `<img src="${photo}" alt="Avatar" style="width:28px;height:28px;border-radius:50%;object-fit:cover">`
      : `<svg viewBox="0 0 24 24" aria-hidden="true" style="width:28px;height:28px">
           <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5Z" fill="currentColor"/>
         </svg>`;

    const badge = on
      ? `<span class="acct-badge" aria-hidden="true"></span>`
      : `<span class="acct-badge off" aria-hidden="true"></span>`;

    el.innerHTML = inner + badge;
  });

  if (st2) st2.textContent = on ? "✅ Connesso a Google" : "❌ Non collegato";
  if (dis) dis.style.display = on ? "inline-flex" : "none";

  // riallinea il menu in base allo stato finale
  if (typeof acct_menuUpdateVisibility === "function") {
    acct_menuUpdateVisibility();
  }
}



// login nuova: prende token con GIS, salva mail/foto, aggiorna UI.

async function g_login() {
  try {
    // 1. ci assicuriamo di avere lo script GIS
    await g_loadGisScript();

    // 2. se non abbiamo ancora il client lo creiamo
    if (!__gisTokenCli && window.google && google.accounts && google.accounts.oauth2) {
      __gisTokenCli = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: GOOGLE_SCOPES,
        callback: async (response) => {
          // --- callback del token ---
          if (!response || !response.access_token) {
            alert("Accesso Google fallito (nessun access_token).");
            return;
          }

          // 2.a salviamo token + scadenza
          const expiresAt = Date.now() + (response.expires_in ? (response.expires_in * 1000) : 3_400_000);
          localStorage.setItem(LS_GOOGLE_TOKEN, response.access_token);
          localStorage.setItem(LS_GOOGLE_EXPIRES_AT, String(expiresAt));

          // 2.b aggiorna subito icone/menu
          g_updateIcons && g_updateIcons();

          // 2.c proviamo a leggere userinfo per prendere email e foto
          let gotEmail = false;
          try {
            const r = await fetch("https://openidconnect.googleapis.com/v1/userinfo", {
              headers: { Authorization: "Bearer " + response.access_token }
            });
            if (r.ok) {
              const info = await r.json();
              if (info.email) {
                localStorage.setItem(LS_GOOGLE_EMAIL, info.email);
                gotEmail = true;
              }
              if (info.picture) {
                localStorage.setItem(LS_GOOGLE_PHOTO, info.picture);
              }
              g_updateIcons && g_updateIcons();
            }
          } catch (_) {
            // non blocchiamo il login
          }

          // 2.d controlliamo che abbia davvero dato Drive
          const okDrive = await g_testDrivePermission();
          if (!okDrive) {
            g_disconnect(true);
            alert("Non hai fornito le autorizzazioni necessarie al salvataggio su Drive.\nRifai l’accesso e metti la spunta.");
            return;
          }

          // 2.e se non siamo riusciti a leggere userinfo, almeno togliamo l’eventuale mail vecchia
          if (!gotEmail) {
            // NON sappiamo chi è → niente mail vecchia
            localStorage.removeItem(LS_GOOGLE_EMAIL);
            g_updateIcons && g_updateIcons();
          }

          // 2.f torna al calendario e fai import auto (come avevi)
          if (typeof ui_switchTab === "function") {
            ui_switchTab("calendar");
          }
          if (typeof storage_importFromGoogleAuto === "function") {
            storage_importFromGoogleAuto();
          }
        }
      });
    }

    if (!__gisTokenCli) {
      alert("Google Identity non inizializzato.");
      return;
    }

    // 3. chiediamo il token (prima volta mostra lo scope brutto)
    __gisTokenCli.requestAccessToken({
      prompt: "consent"
    });

  } catch (e) {
    console.error(e);
    alert("Errore durante l’accesso a Google.\n" + (e && e.message ? e.message : ""));
  }
}

// Disconnessione: revoca e pulizia locale
let __lastDisconnectAt = 0;
async function g_disconnect(silent = false){
  // anti doppio trigger a pochi ms di distanza
  const now = Date.now();
  if (now - __lastDisconnectAt < 500) return;
  __lastDisconnectAt = now;

  if (!silent) {
    const ok = confirm("Vuoi disconnettere l'app da Google?");
    if (!ok) return;
  }
  try{
    const tok = localStorage.getItem(LS_GOOGLE_TOKEN);
    if(tok){
      // Best-effort revoke
      fetch("https://oauth2.googleapis.com/revoke?token="+encodeURIComponent(tok), { method:"POST" }).catch(()=>{});
    }
  }finally{
    localStorage.removeItem(LS_GOOGLE_TOKEN);
    localStorage.removeItem(LS_GOOGLE_EXPIRES_AT);
    localStorage.removeItem(LS_GOOGLE_IDTOKEN);
    localStorage.removeItem(LS_GOOGLE_EMAIL);
    localStorage.removeItem(LS_GOOGLE_PHOTO);
    localStorage.removeItem(LS_GOOGLE_REFRESH);
    g_updateIcons();
    // torniamo al CALENDARIO, non alle impostazioni
    ui_switchTab("calendar");
  }
}

// bind del pulsante "disconnetti" nelle impostazioni (versione unica e stabile)
function g_bindIconClicks(){
  const dis = document.getElementById("acctDisconnect");
  if (!dis) return;

  // rimuove eventuali listener precedenti per evitare doppi click
  dis.replaceWith(dis.cloneNode(true));
  const newDis = document.getElementById("acctDisconnect");

  // collega il click alla disconnessione
  newDis.addEventListener("click", () => g_disconnect(false));
}

// Verifica che Drive sia realmente autorizzato (spunta data)
async function g_testDrivePermission() {
  try {
    await drive_request(
      "https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&pageSize=1&fields=files(id)"
    );
    return true;
  } catch (e) {
    console.warn("Drive non autorizzato:", e);
    showSaveStatus("❌ Manca il permesso Drive (spunta non data)", "#b91c1c");
    return false;
  }
}

// === Recupera info utente Google ===
async function g_fetchUserInfo() {
  const tok = localStorage.getItem(LS_GOOGLE_TOKEN);
  if (!tok) return null;

  try {
    const res = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
      headers: {
        "Authorization": "Bearer " + tok
      }
    });
    if (!res.ok) return null;

    const info = await res.json();

    if (info.email) {
      localStorage.setItem(LS_GOOGLE_EMAIL, info.email);
    }
    if (info.picture) {
      localStorage.setItem(LS_GOOGLE_PHOTO, info.picture);
    }

    if (typeof g_updateIcons === "function") {
      g_updateIcons();
    }

    return info;
  } catch (err) {
    console.warn("g_fetchUserInfo: errore nel leggere userinfo", err);
    return null;
  }
}

// Rinnova l'access token chiedendolo alla tua mini-API su Render
async function g_refreshAccessToken(){
  // se abbiamo l'email dell'utente, la mandiamo, altrimenti va bene anche senza
  const email = localStorage.getItem(LS_GOOGLE_EMAIL) || null;

  const res = await fetch("https://turni-mini-api.onrender.com/oauth2/refresh", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(email ? { email } : {})
  });

  if (!res.ok) {
    // qui il server può rispondere: {error:"No refresh token yet"}
    const txt = await res.text().catch(() => "");
    throw new Error("Impossibile rinnovare il token via mini-API: " + txt);
  }

  const data = await res.json();
  if (!data.access_token) {
    throw new Error("Risposta mini-API senza access_token");
  }

  // data.expires_in arriva tipo 3599 secondi → lo portiamo a ms
  const expiresAt = Date.now() + ((data.expires_in || 3600) * 1000) - 15_000;

  // salviamo ESATTAMENTE come facevi tu prima
  localStorage.setItem(LS_GOOGLE_TOKEN, data.access_token);
  localStorage.setItem(LS_GOOGLE_EXPIRES_AT, String(expiresAt));

  // non abbiamo un nuovo refresh lato browser → NON lo salviamo
  // l'avatar lo aggiorniamo al prossimo giro
  g_updateIcons?.();

  return data.access_token;
}


// Garantisce che ci sia un access token valido, altrimenti prova il refresh per-utente
// Garantisce un access token valido.
// 1) Se il token locale è ancora valido, lo restituisce.
// 2) Altrimenti chiama la mini-API con POST JSON (email nel body se c'è).
// 3) Retry UNA volta su errori temporanei (500/502/503/429) con piccola attesa.
// Garantisce un access token valido: se scaduto/chissà, chiede alla mini-API (POST JSON)
// Tenta UN retry breve se la mini-API risponde 5xx (server che si sveglia).
async function g_ensureValidAccess() {
  const tok = localStorage.getItem(LS_GOOGLE_TOKEN);
  const exp = parseInt(localStorage.getItem(LS_GOOGLE_EXPIRES_AT) || "0", 10);

  // Token ancora valido
  if (tok && Date.now() < (exp - 10_000)) {
    return tok;
  }

  const email = localStorage.getItem(LS_GOOGLE_EMAIL) || "";
  const url   = "https://turni-mini-api.onrender.com/oauth2/refresh";
  const body  = email ? { email } : {};

  const attempt = async () => {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      throw new Error("HTTP " + res.status);
    }

    const data = await res.json();
    if (!data || !data.access_token) {
      throw new Error("refresh senza token");
    }

    const newExp = Date.now() + (data.expires_in ? (data.expires_in * 1000) : 3_400_000);
    localStorage.setItem(LS_GOOGLE_TOKEN, data.access_token);
    localStorage.setItem(LS_GOOGLE_EXPIRES_AT, String(newExp));
    if (data.email && !localStorage.getItem(LS_GOOGLE_EMAIL)) {
      localStorage.setItem(LS_GOOGLE_EMAIL, data.email);
    }
    return data.access_token;
  };

  try {
    return await attempt();
  } catch (e) {
    // Se il server sta ronfando e risponde 5xx, aspetta un soffio e ritenta una volta
    const msg = String(e && e.message || "");
    if (msg.includes("HTTP 5")) {
      await new Promise(r => setTimeout(r, 1200));
      return await attempt();
    }
    throw e;
  }
}



// === MENU OMINO: toggle e azioni ===
// Aggiorna la visibilità voci menù provando prima un refresh silenzioso se serve
async function acct_menuUpdateVisibility(){
  const m = document.getElementById("acctMenu");
  if(!m) return;

  // Stato "grezzo"
  let on = (typeof g_isConnected === "function") ? g_isConnected() : false;

  // Se risulta off, prova UN refresh silenzioso
  if (!on) {
    try {
      await g_ensureValidAccess();
      on = g_isConnected();
    } catch {
      // resta off
    }
  }

  const elLogin  = m.querySelector('[data-act="login"]');
  const elSave   = m.querySelector('[data-act="save"]');
  const elSync   = m.querySelector('[data-act="sync"]');
  const elImport = m.querySelector('[data-act="import-bak"]');
  const elOut    = m.querySelector('[data-act="logout"]');

  if (elLogin)  elLogin.style.display  = on ? "none"  : "block";
  if (elSave)   elSave.style.display   = on ? "block" : "none";
  if (elSync)   elSync.style.display   = on ? "block" : "none";
  if (elImport) elImport.style.display = on ? "block" : "none";
  if (elOut)    elOut.style.display    = on ? "block" : "none";

  // Testatina di stato
  const elHead = document.getElementById("acctHeadStatus");
  if (elHead){
    if (on){
      elHead.textContent = "Sincronizzazione attiva";
      elHead.classList.add("is-on"); elHead.classList.remove("is-off");
    } else {
      elHead.textContent = "Non collegato";
      elHead.classList.add("is-off"); elHead.classList.remove("is-on");
    }
  }
}


// Aggiorna la testatina del menu ("Sincronizzazione attiva" / "Non collegato")
function acct_menuRenderHeadStatus(){
  const on = g_isConnected?.() || false;
  const el = document.getElementById("acctHeadStatus");
  if (!el) return;

  if (on){
    el.textContent = "Sincronizzazione attiva";
    el.classList.add("is-on");
    el.classList.remove("is-off");
  } else {
    el.textContent = "Non collegato";
    el.classList.add("is-off");
    el.classList.remove("is-on");
  }
}


function acct_menuToggle(show){
  // Sposta il menu nel <body> per evitare clipping con la topbar
  acct_menuPortalize();

  const m   = document.getElementById("acctMenu");
  const btn = document.getElementById("acctBtnHeader");
  if(!m || !btn) return;

  const willShow = (typeof show === "boolean") ? show : (m.style.display === "none");

  // CHIUSURA
  if (!willShow){
    m.style.display = "none";
    m.style.left    = "-9999px";
    m.style.top     = "-9999px";
    m.setAttribute("aria-hidden", "true");
    btn.setAttribute("aria-expanded", "false");
    m.classList.remove("show");
    return;
  }

  // APERTURA
  m.style.display = "block";
  m.style.left = "-9999px";
  m.style.top  = "-9999px";
  m.setAttribute("aria-hidden", "false");
  btn.setAttribute("aria-expanded", "true");
  m.classList.add("show");

  // Aggiorna subito le voci e la testatina (verde/grigio)
  acct_menuUpdateVisibility();

  // Posizionamento dopo il reflow
  requestAnimationFrame(()=>{
    const r   = btn.getBoundingClientRect();
    const gap = 8;
    const vw  = window.innerWidth;
    const vh  = window.innerHeight;

    const mb  = m.getBoundingClientRect();
    const mw  = Math.max(200, mb.width  || 200);
    const mh  = Math.max( 80, mb.height ||  80);

    let left = Math.min(Math.max(12, r.right - mw), vw - mw - 12);
    let top  = Math.min(r.bottom + gap, vh - mh - 12);
    if (r.left + mw + 12 > vw) left = Math.max(12, vw - mw - 12);

    m.style.left = left + "px";
    m.style.top  = top  + "px";
  });
}

function acct_menuBind(){
  const btn = document.getElementById("acctBtnHeader");
  const m   = document.getElementById("acctMenu");
  if(!btn || !m) return;

  // 1) Toggle affidabile del menù (senza side-effects)
  btn.addEventListener("click", (e)=>{
    e.preventDefault();
    e.stopPropagation();
    acct_menuToggle();
  });

  // 2) Azioni voci menù (login PRIMA di chiudere: mantiene il “user gesture” per il popup)
  m.addEventListener("click", async (e)=>{
    const t = e.target.closest(".acct-item");
    if(!t) return;
    e.preventDefault();
    e.stopPropagation();

    const act = t.getAttribute("data-act");

    if (act === "login") {
      g_login();
      acct_menuToggle(false);
      return;
    }

    if (act === "logout") {
      acct_menuToggle(false);
      g_disconnect();
      return;
    }

    if (act === "save") {
      acct_menuToggle(false);
      try {
        await storage_saveToGoogle();
      } catch {}
      return;
    }

    if (act === "sync") {
      acct_menuToggle(false);
      try {
        await storage_syncNewestFromDrive();
      } catch {}
      return;
    }

    if (act === "import-bak") {
      acct_menuToggle(false);
      try {
        await storage_importBackupFromGoogle();
      } catch {}
      return;
    }
  });

  // 3) Click fuori: chiudi (ma ignora click dentro menù o sul bottone)
  document.addEventListener("click", (e)=>{
    if (!m.classList.contains("show")) return;
    if (e.target.closest("#acctMenu")) return;
    if (e.target.closest("#acctBtnHeader")) return;
    acct_menuToggle(false);
  }, { capture:true });

  // 4) Esc per chiudere
  document.addEventListener("keydown", (e)=>{
    if (e.key === "Escape" && m.classList.contains("show")) {
      acct_menuToggle(false);
    }
  });

  // 5) Aggiorna visibilità delle voci in base allo stato login
  const _g_updateIcons = g_updateIcons;
  g_updateIcons = function(){
    _g_updateIcons();
    acct_menuUpdateVisibility();
  };
}

// Sposta il menu nel <body> per evitare qualsiasi clipping/stacking con la topbar
function acct_menuPortalize(){
  const m = document.getElementById("acctMenu");
  if (m && m.parentElement !== document.body) {
    document.body.appendChild(m);
  }
}

// bootstrap per lo stato account (riuso in boot_init esistente)
g_updateIcons();


// =========================================================
// [BLOCK: STORAGE SAVE/IMPORT] Drive AppData (REALE)
// + Autosave con debounce
// =========================================================

const DRIVE_FILENAME = "TURNI.json";
const DRIVE_BACKUP_NAME = "TURNI.backup.json";
let __lastSavedSnapshot = null; // firma dell’ultimo payload salvato sul cloud
let __hasUnsavedChanges = false; // segna se ci sono modifiche non salvate
const DRIVE_VERSION_PREFIX = "TURNI-";               // es. TURNI-2025-10-30-12-18-05.json
const DRIVE_MAX_VERSIONS  = 9;                       // quante versioni tenere


// Helper: richiesta autenticata a Drive API (con auto refresh e 1 retry)
async function drive_request(url, opts = {}) {
  // Assicura un access token valido (o prova refresh)
  try { await g_ensureValidAccess(); } catch { throw new Error("Non autenticato a Google."); }

  let tok = localStorage.getItem(LS_GOOGLE_TOKEN);

  const doFetch = async () => {
    const headers = Object.assign(
      { Authorization: "Bearer " + tok },
      opts.headers || {}
    );
    return fetch(url, Object.assign({}, opts, { headers }));
  };

  // Primo tentativo
  let res = await doFetch();

  // Se è scaduto nel frattempo, prova UNA volta a rinfrescare e ritentare
  if (res.status === 401 || res.status === 403) {
    try {
      tok = await g_refreshAccessToken();
      res = await doFetch();
    } catch {
      // se anche il refresh fallisce, lasceremo gestire sotto
    }
  }

  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Drive API error ${res.status}: ${txt}`);
  }
  return res;
}

// Trova per nome nell'appDataFolder
async function drive_findByName(name) {
  const q = encodeURIComponent(
    `name = '${name}' and 'appDataFolder' in parents and trashed = false`
  );
  const url = `https://www.googleapis.com/drive/v3/files?q=${q}&spaces=appDataFolder&fields=files(id,name,modifiedTime)&pageSize=1&orderBy=modifiedTime desc`;
  const res = await drive_request(url);
  const json = await res.json();
  return (json.files && json.files[0]) ? json.files[0] : null;
}

// Wrapper: trova il canonico
async function drive_findCanonical() {
  return drive_findByName(DRIVE_FILENAME);
}

// Lista tutte le versioni tipo TURNI-YYYY-MM-DD-HH-mm-ss.json
async function drive_listVersions() {
  const q = encodeURIComponent(
    `name contains '${DRIVE_VERSION_PREFIX}' and 'appDataFolder' in parents and trashed = false`
  );
  const url = `https://www.googleapis.com/drive/v3/files?q=${q}&spaces=appDataFolder&fields=files(id,name,modifiedTime)&pageSize=100&orderBy=modifiedTime desc`;
  const res = await drive_request(url);
  const json = await res.json();
  return Array.isArray(json.files) ? json.files : [];
}

// Crea un nome versione con timestamp
function drive_buildVersionedName() {
  const d = new Date();
  const pad = n => String(n).padStart(2, "0");
  const yyyy = d.getFullYear();
  const mm   = pad(d.getMonth() + 1);
  const dd   = pad(d.getDate());
  const hh   = pad(d.getHours());
  const mi   = pad(d.getMinutes());
  const ss   = pad(d.getSeconds());
  return `${DRIVE_VERSION_PREFIX}${yyyy}-${mm}-${dd}-${hh}-${mi}-${ss}.json`;
}

// Cancella su Drive per id (best effort)
async function drive_deleteById(fileId) {
  const url = `https://www.googleapis.com/drive/v3/files/${fileId}`;
  try {
    await drive_request(url, { method: "DELETE" });
  } catch (e) {
    // se è un 404 lo ignoriamo, vuol dire che non c'è più e va bene così
    if (e && e.message && e.message.includes("404")) {
      return;
    }
    throw e;
  }
}


// Crea o aggiorna via upload multipart (metadata + contenuto)
async function drive_upload_json(contentObj, existingId = null) {
  // metadata base, valido SEMPRE
  const metadata = {
    name: DRIVE_FILENAME,
    mimeType: "application/json"
  };

  // se è una CREAZIONE (POST) allora si può indicare il parent
  const isCreate = !existingId;
  if (isCreate) {
    metadata.parents = ["appDataFolder"];
  }

  const boundary = "foo_bar_" + Math.random().toString(36).slice(2);
  const body =
    `--${boundary}\r\n` +
    `Content-Type: application/json; charset=UTF-8\r\n\r\n` +
    JSON.stringify(metadata) + `\r\n` +
    `--${boundary}\r\n` +
    `Content-Type: application/json; charset=UTF-8\r\n\r\n` +
    JSON.stringify(contentObj) + `\r\n` +
    `--${boundary}--`;

  const method = isCreate ? "POST" : "PATCH";
  const url = isCreate
    ? `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`
    : `https://www.googleapis.com/upload/drive/v3/files/${existingId}?uploadType=multipart`;

  const res = await drive_request(url, {
    method,
    headers: { "Content-Type": `multipart/related; boundary=${boundary}` },
    body
  });
  return res.json();
}


// Crea o aggiorna un file con nome specifico (usato per backup)
async function drive_upload_named_json(name, contentObj, existingId = null) {
  const metadata = {
    name,
    mimeType: "application/json"
  };

  const isCreate = !existingId;
  if (isCreate) {
    metadata.parents = ["appDataFolder"];
  }

  const boundary = "foo_bar_" + Math.random().toString(36).slice(2);
  const body =
    `--${boundary}\r\n` +
    `Content-Type: application/json; charset=UTF-8\r\n\r\n` +
    JSON.stringify(metadata) + `\r\n` +
    `--${boundary}\r\n` +
    `Content-Type: application/json; charset=UTF-8\r\n\r\n` +
    JSON.stringify(contentObj) + `\r\n` +
    `--${boundary}--`;

  const method = isCreate ? "POST" : "PATCH";
  const url = isCreate
    ? `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`
    : `https://www.googleapis.com/upload/drive/v3/files/${existingId}?uploadType=multipart`;

  const res = await drive_request(url, {
    method,
    headers: { "Content-Type": `multipart/related; boundary=${boundary}` },
    body
  });
  return res.json();
}

// Scarica il contenuto del file (alt=media)
async function drive_download_json(fileId) {
  const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
  const res = await drive_request(url);
  return res.json();
}

// DEBUG: elenca tutto quello che c'è nell'appDataFolder di QUESTO progetto
async function drive_debugListAll() {
  try {
    const url = "https://www.googleapis.com/drive/v3/files"
      + "?spaces=appDataFolder"
      + "&fields=files(id,name,modifiedTime,size),nextPageToken"
      + "&pageSize=100";
    const res = await drive_request(url);
    const json = await res.json();
    console.log("📦 appDataFolder:", json.files || []);
  } catch (e) {
    console.error("Errore nel list appDataFolder:", e);
  }
}


// ritorna la lista dei file TURNI* in appDataFolder ordinati dal più nuovo
async function drive_listTurniFiles(accessToken) {
  const q = encodeURIComponent("name contains 'TURNI'");  // se il tuo prefisso è diverso, lo cambiamo dopo
  const url = "https://www.googleapis.com/drive/v3/files"
            + "?spaces=appDataFolder"
            + "&q=" + q
            + "&fields=files(id,name,modifiedTime,size)"
            + "&pageSize=100"
            + "&orderBy=modifiedTime desc";

  const res = await fetch(url, {
    headers: {
      "Authorization": "Bearer " + accessToken
    }
  });

  if (!res.ok) {
    const txt = await res.text();
    throw new Error("drive_listTurniFiles fallita: " + res.status + " " + txt);
  }

  const data = await res.json();
  return data.files || [];
}

// crea un nuovo file TURNI-YYYYMMDD-HHMMSS.json in appDataFolder
async function drive_uploadTurniFile(snapshotJsonString, accessToken) {
  const now  = new Date();
  const name =
    "TURNI-" +
    now.getFullYear().toString().padStart(4, "0") +
    (now.getMonth() + 1).toString().padStart(2, "0") +
    now.getDate().toString().padStart(2, "0") +
    "-" +
    now.getHours().toString().padStart(2, "0") +
    now.getMinutes().toString().padStart(2, "0") +
    now.getSeconds().toString().padStart(2, "0") +
    ".json";

  const metadata = {
    name,
    parents: ["appDataFolder"]
  };

  const boundary = "-------314159265358979323846";
  const body =
    "--" + boundary + "\r\n" +
    "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
    JSON.stringify(metadata) + "\r\n" +
    "--" + boundary + "\r\n" +
    "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
    snapshotJsonString + "\r\n" +
    "--" + boundary + "--";

  const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + accessToken,
      "Content-Type": "multipart/related; boundary=" + boundary
    },
    body
  });

  if (!res.ok) {
    const txt = await res.text();
    throw new Error("drive_uploadTurniFile fallita: " + res.status + " " + txt);
  }

  return await res.json();
}


async function drive_deleteFile(fileId, accessToken) {
  const res = await fetch("https://www.googleapis.com/drive/v3/files/" + encodeURIComponent(fileId), {
    method: "DELETE",
    headers: {
      "Authorization": "Bearer " + accessToken
    }
  });

  // se è già sparito, amen
  if (!res.ok && res.status !== 404) {
    const txt = await res.text();
    throw new Error("drive_deleteFile fallita: " + res.status + " " + txt);
  }
}

function showSaveStatus(text, color) {
  let el = document.getElementById('saveStatus');
  if (!el) {
    el = document.createElement('div');
    el.id = 'saveStatus';
    el.style.position = 'fixed';
    el.style.top = '10px';
    el.style.right = '10px';
    el.style.background = 'rgba(0,0,0,.75)';
    el.style.color = 'white';
    el.style.padding = '6px 12px';
    el.style.borderRadius = '8px';
    el.style.fontSize = '14px';
    el.style.fontWeight = '500';
    el.style.zIndex = '9999';
    el.style.opacity = '0';
    el.style.transition = 'opacity .3s';
    el.style.pointerEvents = 'none';
    document.body.appendChild(el);
  }

  el.textContent = text;
  el.style.background = color;
  el.style.opacity = '1';

  clearTimeout(el._hideTimer);
  el._hideTimer = setTimeout(() => {
    el.style.opacity = '0';
  }, 3000);
}


// Salva (manuale) con rotazione 10 versioni, senza TURNI.json
async function storage_saveToGoogle() {
  if (!g_isConnected()) {
    showSaveStatus("Non sei connesso a Google", "#e53e3e");
    return;
  }

  // Allinea prima i dati dalla UI
  ui_settingsApply();

  const payload  = storage_buildPayload();
  const snapshot = JSON.stringify(payload);

  // se non è cambiato niente
  if (__lastSavedSnapshot === snapshot) {
    showSaveStatus("Nessuna modifica da salvare", "#2d3748");
    __hasUnsavedChanges = false;
    return;
  }

  let accessToken;
  try {
    // QUI: può fallire se la mini-API è giù
    accessToken = await g_ensureValidAccess();
  } catch (err) {
    console.warn("storage_saveToGoogle: token non ottenuto:", err && err.message ? err.message : err);

    // caso specifico: mini-API non raggiungibile
    if (err && err.message && err.message.includes("Mini-API KO")) {
      showSaveStatus("Server di rinnovo offline. Riprova tra poco.", "#e53e3e");
    } else {
      showSaveStatus("Impossibile ottenere un token valido.", "#e53e3e");
    }
    return;
  }

  try {
    // prendo TUTTI i TURNI* già presenti
    const files = await drive_listTurniFiles(accessToken); // già ordinati dal più nuovo al più vecchio
    const MAX_FILES = 10;

    // carico il nuovo contenuto, sempre con LO STESSO token
    await drive_uploadTurniFile(snapshot, accessToken);

    // cancello eventuali vecchi
    if (files && files.length > MAX_FILES) {
      const toDelete = files.slice(MAX_FILES);
      for (const f of toDelete) {
        try {
          await drive_deleteFile(f.id, accessToken);
        } catch (e) {
          console.warn("Impossibile cancellare vecchio backup:", f.id, e);
        }
      }
    }

    // tutto ok
    __lastSavedSnapshot = snapshot;
    __hasUnsavedChanges = false;
    showSaveStatus("Salvato su Google Drive", "#38a169");
  } catch (err) {
    console.error("Errore durante il salvataggio su Drive:", err);
    showSaveStatus("Errore durante il salvataggio", "#e53e3e");
  }
}



// Importa il file canone
async function storage_importFromGoogle() {
  if (!g_isConnected()) {
    alert("Non sei connesso a Google.");
    return;
  }
  try {
    const file = await drive_findCanonical();
    if (!file) {
      alert("Nessun file trovato in Drive AppData.");
      return;
    }
    const obj = await drive_download_json(file.id);

    if (obj.settings) settings_save(obj.settings);
    if (Array.isArray(obj.defs)) defs_save(obj.defs);

    ui_settingsInit();
    render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());
    // allinea la firma: da ora in poi non risalviamo se non cambia davvero
    __lastSavedSnapshot = JSON.stringify(storage_buildPayload());

    const st = document.getElementById("cloudStatusSettings");
    if (st) st.textContent = `✅ Importato da Drive AppData: ${file.name}`;
  } catch (e) {
    console.error(e);
    alert("Errore nell’importazione da Drive.");
  }
}


// Importa una delle versioni TURNI* dall'appDataFolder, con avviso se perderai modifiche
// Importa una delle versioni TURNI* dall'appDataFolder
async function storage_importBackupFromGoogle() {
  if (!g_isConnected()) {
    alert("Non sei connesso a Google.");
    return;
  }

  try {
    const accessToken = await g_ensureValidAccess();
    const files = await drive_listTurniFiles(accessToken);
    if (!files.length) {
      alert("Nessun backup disponibile su Drive.");
      return;
    }

    const names = files.map((f, idx) => `${idx+1}. ${f.name}`).join("\n");
    const ans = prompt(
      "Seleziona il backup da ripristinare (numero):\n\n" + names + "\n\nLascia vuoto per annullare.",
      "1"
    );
    if (!ans) return;

    const selIdx = parseInt(ans, 10) - 1;
    const chosen = files[selIdx];
    if (!chosen) {
      alert("Numero non valido.");
      return;
    }

    if (typeof __hasUnsavedChanges !== "undefined" && __hasUnsavedChanges) {
      const go = confirm(
        "Hai modifiche locali non salvate.\n" +
        "Se importi un backup, le perderai.\n\n" +
        "Vuoi procedere comunque?"
      );
      if (!go) return;
    }

    const obj = await drive_download_json(chosen.id);

    if (obj.settings) settings_save(obj.settings);
    if (Array.isArray(obj.defs)) defs_save(obj.defs);

    ui_settingsInit();
    render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());

    if (typeof storage_buildPayload === "function") {
      __lastSavedSnapshot = JSON.stringify(storage_buildPayload());
    }
    showSaveStatus(`✅ Ripristinato: ${chosen.name}`, "#0f766e");
  } catch (e) {
    console.error(e);
    showSaveStatus("❌ Errore nel ripristino da Drive", "#b91c1c");
  }
}




// Prende il TURNI* più recente e lo applica, ma avvisa se perdi roba
// Prende il TURNI* più recente e lo applica, avvisando se perdi roba
async function storage_syncNewestFromDrive() {
  if (!g_isConnected()) {
    alert("Non sei connesso a Google.");
    return;
  }

  try {
    // 1) TOKEN VALIDO
    const accessToken = await g_ensureValidAccess();

    // 2) LISTA FILE con TOKEN
    const files = await drive_listTurniFiles(accessToken);
    if (!files.length) {
      alert("Nessun file TURNI trovato in Drive.");
      return;
    }

    const latest = files[0];

    // 3) Avviso se hai modifiche locali
    if (typeof __hasUnsavedChanges !== "undefined" && __hasUnsavedChanges) {
      const go = confirm(
        "Attenzione: hai modifiche locali non salvate.\n" +
        "Se sincronizzi ora verranno sovrascritte dai dati Drive.\n\n" +
        "Vuoi procedere lo stesso?"
      );
      if (!go) return;
    }

    // 4) SCARICO e APPLICO
    const remoteObj = await drive_download_json(latest.id);
    if (remoteObj.settings) settings_save(remoteObj.settings);
    if (Array.isArray(remoteObj.defs)) defs_save(remoteObj.defs);

    ui_settingsInit();
    render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());

    if (typeof storage_buildPayload === "function") {
      __lastSavedSnapshot = JSON.stringify(storage_buildPayload());
    }
    if (typeof __hasUnsavedChanges !== "undefined") {
      __hasUnsavedChanges = false;
    }

    showSaveStatus(`✅ Sincronizzato: ${latest.name}`, "#0f766e");
  } catch (e) {
    console.error(e);
    showSaveStatus("❌ Errore sincronizzazione", "#b91c1c");
  }
}


// =======================
// AUTOSAVE ENGINE (disattivato per test)
// =======================
let __autosave_timer = null;
let __autosave_pending = false;
const AUTOSAVE_ENABLED = false;

function autosave_schedule(delayMs = 800) {
  if (!AUTOSAVE_ENABLED) return;
  __autosave_pending = true;
  clearTimeout(__autosave_timer);
  __autosave_timer = setTimeout(async () => {
    try {
      if (g_isConnected()) {
        await storage_saveToGoogle();
      }
    } catch (e) {
      console.error("Autosave error:", e);
    } finally {
      __autosave_pending = false;
    }
  }, delayMs);
}

async function autosave_now() {
  if (!g_isConnected()) return;
  try { await storage_saveToGoogle(); } catch(e){ console.error(e); }
  __autosave_pending = false;
}


  // =========================================================
  // [BLOCK: BOOTSTRAP] DOM ready
  // =========================================================
  function boot_init(){

  document.getElementById('prev').addEventListener('click', ()=>nav_shift(-1));
  document.getElementById('next').addEventListener('click', ()=>nav_shift(1));

  document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click', ()=>ui_switchTab(t.dataset.tab)));

  document.getElementById('btnAddTurno').addEventListener('click', ui_defsAdd);

  // Bind azioni cloud (restano, ma l'utente non deve usarle: l'autosave pensa a tutto)
  const btnSaveCloud  = document.getElementById('btnSaveCloud');
  const btnImportCloud= document.getElementById('btnImportCloud');
  if(btnSaveCloud)   btnSaveCloud.addEventListener('click', storage_saveToGoogle);
  if(btnImportCloud) btnImportCloud.addEventListener('click', storage_importFromGoogle);

// Account: bind icone + stato
g_bindIconClicks();
g_updateIcons();

// Porta il menu nel <body> prima di collegare gli handler
acct_menuPortalize();
acct_menuBind();

  // Init UI
  ui_settingsInit();
  render_buildMonth(view.getUTCFullYear(), view.getUTCMonth());

  // Autosave anche quando cambia la data di ancoraggio
  const sd = document.getElementById('startDate');
  if (sd) sd.addEventListener('change', ui_settingsApply);

  // Vista iniziale: calendario senza scroll globale
  document.body.classList.add('no-scroll');

    // Glow
  ui_updateTopbarGlowCenter();
  addEventListener('resize', ui_updateTopbarGlowCenter, { passive:true });
  addEventListener('scroll', ui_updateTopbarGlowCenter, { passive:true });
  requestAnimationFrame(ui_updateTopbarGlowCenter);
}

  if (document.readyState === 'loading') {
    window.addEventListener('DOMContentLoaded', boot_init);
  } else {
    boot_init();
  }

  // [SERVICE WORKER] – registrazione con auto-update (fix percorsi localhost/GitHub)
(function(){
  if (!('serviceWorker' in navigator)) return;

  const SW_VERSION = '2025-11-04-01'; // bump
  const BASE  = (location.hostname === 'localhost') ? '' : '/turni-pds';
  const SW_URL = `${BASE}/service-worker.js?v=${SW_VERSION}`;
  const SCOPE  = `${BASE}/`;

  async function registerSW(){
    try{
      const reg = await navigator.serviceWorker.register(SW_URL, { scope: SCOPE });
      if (reg.waiting) { reg.waiting.postMessage({ type: 'SKIP_WAITING' }); }
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        if (!nw) return;
        nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            nw.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!window.__reloadedForSW) {
          window.__reloadedForSW = true;
          location.reload();
        }
      });
      reg.update().catch(()=>{});
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          reg.update().catch(()=>{});
        }
      });
    }catch(e){}
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', registerSW);
  } else {
    registerSW();
  }
})();


  // ======================= //
  // fine JSS (script)       //
  // ======================= //
  </script>

</body>
<!-- ======================= -->
<!-- fine body             -->
<!-- ======================= -->
</html>
<!-- ======================= -->
<!-- fine html             -->
<!-- ======================= -->
